{"changed":true,"filter":false,"title":"black-book.js","tooltip":"/static/js/black-book.js","value":"//var google={};\nvar rayv = rayv || {};\n/**\n * create a geo posn\n * @param lat\n * @param lng\n * @constructor\n */\nrayv.LatLng = function (lat, lng) {\n    this.lat = lat;\n    this.lng = lng;\n    this.googleFormat = function () {\n        return new google.maps.LatLng(this.lat, this.lng);\n    };\n    this.loadFromGoogleFormat = function (g_fmt) {\n        this.lat = g_fmt.lat();\n        this.lng = g_fmt.lng();\n        return this;\n    }\n};\n\nrayv.currentItem = rayv.currentItem || {};\n(function () {\n    this.address = \"\";\n    this.position = new rayv.LatLng(0.0, 0.0);\n    this.place_name = \"\";\n    this.descr = \"\";\n    this.category = \"\";\n    this.key = \"\";\n    this.vote = 0;\n    this.website = \"\";\n    this.mine = \"\";\n    this.img = null;\n    this.rotation = 0;\n    this.telephone = null;\n    this.distance = null;\n    this.untried = null;\n    /**\n     * loads the current item given its key\n     * @param [key] {string} - urlsafe key\n     */\n    this.loadFromKey = function (key) {\n        if (!key) {\n            key = this.key;\n        }\n        if (key) {\n            try {\n                _innerLoad(rayv.UserData.places.get(key), false);\n            }\n            catch (e) {\n                console.error('loadFromKey')\n            }\n        }\n    };\n    /**\n     * loads the currentItem from an ajax return object\n     * @param data {object} The ajax objet\n     * @param is_json {bool} is the object already parsed as json?\n     * @private\n     */\n    var _innerLoad = function (data, is_json) {\n        var obj = is_json ? jQuery.parseJSON(data) : data;\n        rayv.currentItem.address = obj.address;\n        console.assert(rayv.currentItem.address != null);\n        console.assert(rayv.currentItem.address != \"null\");\n        rayv.currentItem.place_name = obj.place_name;\n        rayv.currentItem.category = obj.category;\n        console.log(\"_innerLoad: \" + obj.category);\n        rayv.currentItem.descr = obj.descr;\n        rayv.currentItem.telephone = obj.telephone;\n        rayv.currentItem.website = obj.website;\n        rayv.currentItem.position = new rayv.LatLng(obj.lat, obj.lng);\n        rayv.currentItem.lat = obj.lat;\n        rayv.currentItem.lng = obj.lng;\n        rayv.currentItem.key = obj.key;\n        rayv.currentItem.mine = obj.mine;\n        rayv.currentItem.img = obj.img;\n        rayv.currentItem.vote = obj.vote;\n        rayv.currentItem.distance = obj.distance;\n        rayv.currentItem.rotation = 0;\n        rayv.currentItem.untried = obj.untried;\n    };\n    /**\n     * Clears the currentItem\n     */\n    this.clear = function () {\n        rayv.currentItem.address = \"\";\n        rayv.currentItem.place_name = \"\";\n        rayv.currentItem.category = \"\";\n        rayv.currentItem.website = \"\";\n        rayv.currentItem.descr = \"\";\n        rayv.currentItem.position = new rayv.LatLng(0, 0);\n        rayv.currentItem.key = null;\n        rayv.currentItem.mine = \"\";\n        rayv.currentItem.img = \"\";\n        rayv.currentItem.vote = \"\";\n        rayv.currentItem.distance = \"\";\n        rayv.currentItem.rotation = \"\";\n    }\n}).apply(rayv.currentItem);\n\n\nDictStore = function (dict_name) {\n    this.dict_name = dict_name;\n    var has_local_storage = !(typeof window.localStorage == 'undefined');\n    var mem_data = null;\n    this.make_key = function (k) {\n        return this.dict_name + ':' + k;\n    };\n\n    this.is_empty = function () {\n        // try a load first\n        if (mem_data && mem_data.length > 0) {\n            return false;\n        }\n        this.load();\n        // if, after a load, still empty then it's Really Empty\n        if (!mem_data || mem_data.length == 0) {\n            return true;\n        }\n        ;\n        return false;\n    };\n    /**\n     * load from localStorage\n     */\n    this.load = function () {\n        mem_data = {};\n        var item_key_starts_at = this.dict_name.length + 1;\n        for (var i = 0; i < window.localStorage.length; i++) {\n            var key = window.localStorage.key(i);\n            if (key.indexOf(this.dict_name) == 0) {\n\n                var stored = window.localStorage.getItem(key);\n                if (stored) {\n                    var k = key.substring(item_key_starts_at);\n                    var obj = JSON.parse(stored);\n                    mem_data[k] = obj;\n                }\n                ;\n            }\n        }\n    };\n    /**\n     * Store in mem & localStorage\n     * @param k {string} key\n     * @param v {Object} value - must be serialisable\n     */\n    this.set = function (k, v) {\n        if (!mem_data) {\n            this.load();\n        }\n        mem_data[k] = v;\n        if (has_local_storage) {\n            var json_val = JSON.stringify(v);\n            window.localStorage.setItem(this.make_key(k), json_val);\n        }\n    };\n    /**\n     * get value from local storage\n     * @param k {string} key\n     * @returns {Object}\n     */\n    this.get = function (k) {\n        if (!mem_data) {\n            this.load();\n        }\n        if (mem_data.hasOwnProperty(k)) {\n            return mem_data[k];\n        }\n        return null;\n    };\n    this.exists = function (k) {\n        if (!mem_data) {\n            this.load();\n        }\n        if (mem_data.hasOwnProperty(k)) {\n            return true;\n        }\n        return false;\n    };\n    this.clear = function () {\n        if (has_local_storage) {\n            for (k in mem_data) {\n                window.localStorage.removeItem(this.make_key(k));\n            }\n        }\n        mem_data = {};\n    };\n    this.forEach = function (fn) {\n        for (k in mem_data) {\n            fn(mem_data[k]);\n        }\n    }\n\n};\n\nObjectStore = function (obj_name) {\n    this.obj_name = obj_name;\n    var has_local_storage = !(typeof window.localStorage == 'undefined');\n    var obj = null;\n    /**\n     * load from localStorage\n     */\n    this.load = function () {\n        obj = JSON.parse(localStorage.getItem(this.obj_name + ':'));\n    };\n    /**\n     * Store in mem & localStorage\n     * @param k {string} key\n     * @param v {Object} value - must be serialisable\n     */\n    this.set = function (v) {\n        if (!obj) {\n            this.load();\n        }\n        obj = v;\n        if (has_local_storage) {\n            var json_val = JSON.stringify(v);\n            window.localStorage.setItem(this.obj_name + ':', json_val);\n        }\n    };\n    this.get = function () {\n        if (!obj) {\n            this.load();\n        }\n        return obj;\n    };\n\n};\n\n//todo: put this in local storage\nrayv.UserData = rayv.UserData || {};\n(function () {\n    this.places = new DictStore('PLACE');\n    this.myBook = new ObjectStore('MYBOOK');\n    this.friends = new DictStore('FRIEND');\n    this.lastUpdate = new ObjectStore('LASTUPDATE');\n\n    this.init = function () {\n        var LSsupport = !(typeof window.localStorage == 'undefined');\n        if (LSsupport) {\n            console.log(\"localStorage and sessionStorage are available\");\n            this.has_local_storage = true;\n            this.storage = window.localStorage;\n        }\n        rayv.UserData.my_id = new ObjectStore('my_id');\n        rayv.UserData.my_id.set(0);\n    };\n\n    /**\n     * adds places to the cache\n     * only adds - no deletion here (as we don't ref count)\n     * @param obj {object} has a .places element which is {list}\n     */\n    var updatePlaceCache = function (obj) {\n        for (var idx in obj.places) {\n            //noinspection JSUnfilteredForInLoop\n            var place = obj.places[idx];\n            if (!rayv.UserData.places.exists(place.key)) {\n                // dict indexed by place key\n                rayv.UserData.places.set(place.key, place);\n            }\n        }\n    };\n    /**\n     * get All user data from the server\n     * @param callback {function} callback on completion\n     */\n    this.load = function (callback) {\n        var request = {};\n        var last_update = rayv.UserData.lastUpdate.get();\n        if (rayv.UserData.places.is_empty()){\n            rayv.UserData.places.load();\n        };\n        if (last_update && !rayv.UserData.places.is_empty()) {\n            request.since = last_update;\n            callback();\n        }\n        else {\n            if (!BB.splash) {\n                $(\"#list-loading\").show();\n            }\n        }\n        $.get(\"/getFullUserRecord\",\n            request,\n            function (data) {\n                //populate the list\n                var obj = $.parseJSON(data);\n                my_id = obj.id;\n                // first one is me\n                rayv.UserData.myBook.set(obj.friendsData[0]);\n                rayv.UserData.lastUpdate.set((new Date()).getTime());\n                if (!request.since) {\n                    rayv.UserData.places.clear();\n                }\n                ;\n                updatePlaceCache(obj);\n                rayv.UserData.friends.clear();\n                var skippedFirstAsThatOneIsMe = false;\n                obj.friendsData.forEach(function (data) {\n                    if (skippedFirstAsThatOneIsMe) {\n                        // dictionary indexed by user id\n                        rayv.UserData.friends.set(data.id, data);\n                    }\n                    else {\n                        skippedFirstAsThatOneIsMe = true;\n                    }\n                });\n                callback();\n            });\n    };\n    /**\n     * load, cache & display the thumbs for the current list, async\n     * @param listULId {string} element ID of the list\n     */\n    this.getThumbs = function (listULId) {\n        $(listULId).find(\"li\").each(function () {\n            // get the data-key from the <a>\n            var key = $(this).find('a').data('key');\n            // lookup the place for that key\n            var place = rayv.UserData.places.get(key);\n            // if no cached image\n            if (place.imageData) {\n                // replace the existing image with cached one\n                $(this).find(\".item-img-container\").html(place.imageData);\n            }\n            else {\n                //      get the image URL\n                var imgUrl = place['thumbnail'];\n                //      blank means no thumb\n                if (imgUrl == \"\") {\n                    //      no image\n                    $(this).find(\".item-pic\").attr(\"src\", \"\");\n                }\n                else {\n                    //todo: create the cached image\n                    var imgCache = $(\"<img>\");\n                    //      create img, load from URL\n                    imgCache.attr(\"src\", imgUrl);\n                    //      class for w x h\n                    imgCache.addClass('item-pic');\n                    //      cache it\n                    place.imageData = imgCache;\n                    //todo: load the cached image into the dom\n                    // replace the existing image\n                    $(this).find(\".item-img-container\").html(imgCache);\n                }\n            }\n        });\n    };\n\n    /**\n     * gets the single most relevant comment for a place\n     * my comment, else a friend's\n     * @param key {string} the key to the object\n     * @returns {string} comment text\n     */\n    this.get_most_relevant_comment = function (key) {\n        var myBook = this.myBook.get();\n        if (myBook.votes[key]) {\n            return myBook.votes[key].comment\n        }\n        //not in my list\n        var comment = \"\";\n        this.friends.forEach(function (friend) {\n            //noinspection JSUnfilteredForInLoop\n            if (friend.votes[key]) {\n                comment = friend.votes[key].comment\n            }\n        });\n        return comment;\n    };\n\n    /**\n     * gets my comment for a place\n     * @param key {string} the key to the object\n     * @returns {string} comment text\n     */\n    this.get_my_comment = function (key) {\n        // my comment;\n        var myBook = this.myBook.get();\n        if (myBook.votes[key]) {\n            return myBook.votes[key].comment\n        }\n        return '';\n    };\n\n    /**\n     * gets all the vote for a place give the key\n     * @param key {string} urlsafe place key\n     * @returns {Array} of votes\n     */\n    this.get_votes_for_item = function (key) {\n        var result = [];\n        this.friends.forEach(function (friend) {\n            //noinspection JSUnfilteredForInLoop\n            var vote = {name: friend.name};\n            if (friend.votes[key]) {\n                vote.vote = friend.votes[key];\n                result.push(vote);\n            }\n        });\n        return result;\n    }\n}).apply(rayv.UserData);\n\n\nvar BB = {\n        isOnline: true,\n        //global timestamp = time of next list load - initially one minute ago\n        nextListLoad: null,\n        mapInfoWindows: [],\n        mapMarkers: [],\n        creatorMapMarker: null,\n        marker: null,\n        navBarActive: false,\n        lastGPSPosition: new rayv.LatLng(0, 0),\n        // map_centred set if blue home button pressed, reset if dragged\n        map_centred: false,\n        lastGPSTime: 0,\n        lastMapPosition: {\"position\": new rayv.LatLng(0, 0),\n            \"isSet\": false,\n            \"zoomIn\": false},\n        theMap: null,\n        creatorMap: null,\n        geocoder: null,\n        iconPath: \"/static/images/\",\n        filter: \"mine\",\n        use_test_location: false,\n        test_position: new rayv.LatLng(0, 0),\n        imageRotation: 0,\n        watchPositionOptions: {\n            enableHighAccuracy: true,\n            maximumAge: 30000 //30 seconds\n        },\n        detail_saving: false,\n        /**\n         * hide all waiting spinners\n         */\n        hide_waiting: function () {\n            $('.waiting').hide();\n            BB.detail_saving = false;\n            console.log('hide_waiting timeout');\n        },\n        /**\n         * show the requested spinner\n         * @param selector {string} jQuery selector for the element\n         * @returns {number} time id\n         */\n        show_waiting: function (selector) {\n            //show the ajax spinner & set time to turn off\n            var timer = window.setTimeout(BB.hide_waiting, 20000);\n            $(selector).show();\n            BB.detail_saving = true;\n            return timer;\n        },\n        /**\n         * center the map\n         */\n        map_center: function () {\n            var last = BB.lastGPSPosition.googleFormat();\n            BB.theMap.setCenter(last);\n            BB.dragMap();\n            BB.map_centred = true;\n        },\n        /**\n         * set up the main map\n         */\n        map_init: function () {\n            //map\n            var mapOptions = {\n                zoom: 14,\n                center: new google.maps.LatLng(-34.397, 150.644)\n            };\n            BB.theMap = new google.maps.Map(document.getElementById('map-div'),\n                mapOptions);\n            google.maps.event.addListener(BB.theMap, 'dragend', BB.dragMap);\n            // Create a div to hold the control.\n            var controlDiv = document.createElement('div');\n\n            // Set CSS styles for the DIV containing the control\n            // Setting padding to 5 px will offset the control\n            // from the edge of the map.\n            controlDiv.style.padding = '5px';\n\n            // Set CSS for the control border.\n            var controlUI = document.createElement('div');\n            //controlUI.style.backgroundColor = 'white';\n            controlUI.style.borderStyle = 'none';\n            //controlUI.style.borderWidth = '2px';\n            controlUI.style.cursor = 'pointer';\n            controlUI.style.padding = '5px';\n            //controlUI.style.textAlign = 'center';\n            controlUI.title = 'Click to set the map to Home';\n            controlDiv.appendChild(controlUI);\n\n            // Set CSS for the control interior.\n            var controlImg = document.createElement('img');\n            controlImg.setAttribute(\"src\", \"/static/images/centre-button.png\");\n            controlUI.appendChild(controlImg);\n            google.maps.event.addDomListener(controlUI, 'click', BB.map_center);\n            BB.theMap.controls[google.maps.ControlPosition.LEFT_CENTER].\n                push(controlUI);\n        },\n        /**\n         * initialise app on load\n         */\n        init: function () {\n            BB.splash = true;\n            $(\"#list-loading\").hide();\n            BB.geocoder = new google.maps.Geocoder();\n            BB.map_init();\n\n        },\n\n        /**\n         * every server call, we look for dirty data and append it if needed\n         * @param obj {object} ajax return object\n         */\n        check_for_dirty_data: function (obj) {\n            if (obj) {\n                if (\"dirty_list\" in obj) {\n                    for (var frIdx in obj.dirty_list.friends) {\n                        //these friends are dirty\n                        //noinspection JSUnfilteredForInLoop\n                        rayv.UserData.friends.set(\n                            obj.dirty_list.friends[frIdx].id,\n                            obj.dirty_list.friends[frIdx]);\n                    }\n                    for (var plIdx in obj.dirty_list.places) {\n                        //these places are dirty\n                        //noinspection JSUnfilteredForInLoop\n                        rayv.UserData.places.set(\n                            obj.dirty_list.places[plIdx].key,\n                            obj.dirty_list.places[plIdx]);\n                    }\n                }\n\n            }\n        },\n\n        /**\n         * get the distance as yards if close, else miles\n         * @param dist {number} distance in miles\n         * @returns {string} prettified distance string\n         */\n        pretty_dist: function (dist) {\n            if (dist >= 1.0) {\n                return dist.toFixed(1) + \" miles\";\n            }\n            var yds = Math.floor(dist * 90) * 20;\n            return yds + \" yds\";\n        },\n\n        /**\n         * one in 60 rule distance calc\n         * @param point {LatLng}\n         * @param origin {LatLng}\n         * @returns {number} distance between points\n         */\n        approx_distance: function (point, origin) {\n            //based on 1/60 rule\n            //delta lat. Degrees * 69 (miles)\n            var p_lat , p_lng;\n            try {\n                p_lat = point.lat;\n                p_lng = point.lng;\n            }\n            catch (e) {\n                p_lat = point[\"lat\"];\n                p_lng = point[\"lng\"];\n            }\n            var d_lat = (origin.lat - p_lat) * 69;\n            //cos(lat) approx by 1/60\n            var cos_lat = Math.min(1, (90 - p_lat) / 60);\n            //delta lng = degrees * cos(lat) *69 miles\n            var d_lng = (origin.lng - p_lng) * 69 * cos_lat;\n            return Math.sqrt(d_lat * d_lat + d_lng * d_lng);\n        },\n\n        /**\n         * log the message\n         * @param msg {string} message\n         */\n        log: function (msg) {\n            try {\n                console.log(msg + \" / map lat :\" + BB.theMap.getCenter().lat());\n            }\n            catch (e) {\n                console.log(msg);\n            }\n        },\n\n\n        /**\n         * we have changed the current item, update the cache\n         * @returns {boolean} updated\n         */\n        updateCurrentItemInCache: function () {\n            var item = rayv.currentItem;\n            item.address = rayv.currentItem.address;\n            item.category = rayv.currentItem.category;\n            if ((item.img != rayv.currentItem.img) ||\n                (item.vote != rayv.currentItem.vote)) {\n                console.log(\"Can't update in cache - reload\");\n                return false;\n            }\n            var myBook = rayv.UserData.myBook.get();\n            var vote = myBook.votes[rayv.currentItem.key];\n            if (!vote) {\n                myBook.votes[rayv.currentItem.key] = {\n                    vote: 0,\n                    comment: '',\n                    untried: false\n                };\n                vote = myBook.votes[rayv.currentItem.key];\n            }\n            ;\n            if (rayv.currentItem.vote == 'dislike') {\n                vote.vote = -1;\n            }\n            if (rayv.currentItem.vote == 'like') {\n                vote.vote = 1;\n            }\n            vote.untried = vote.vote == 0;\n            vote.comment = rayv.currentItem.descr;\n            rayv.UserData.myBook.set(myBook);\n            console.log(\"Updated in cache \");\n            //rayv.UserData.places.set(rayv.currentItem.key, rayv.currentItem);\n            return true;\n        },\n\n        /**\n         * encode a latLng\n         */\n        codeLatLng: function () {\n            BB.geocoder.geocode({'latLng': BB.creatorMap.getCenter()},\n                function (results, status) {\n                    if (status == google.maps.GeocoderStatus.OK) {\n                        if (results[1]) {\n                            var el = $(\"#dragged-address\");\n                            el.text(results[0].formatted_address);\n                            el.show();\n                            $(\"#create-new-save-btn\").removeClass(\"ui-disabled\")\n                        }\n                    } else {\n                        $(\"#create-new-save-btn\").addClass(\"ui-disabled\");\n                        console.log(\"Geocoder failed due to: \" + status);\n                    }\n                });\n        },\n\n        /**\n         * save to server\n         */\n        saveCurrentItem: function () {\n            console.log(\"saveCurrentItem\");\n            var file = $(\"#image-input\").prop(\"files\")[0];\n            // https://github.com/gokercebeci/canvasResize\n            function build_form(f) {\n                var fd = new FormData();\n                if (f) {\n                    fd.append(\"new-photo\", f);\n                }\n                fd.append(\"new-item-category\", rayv.currentItem.category);\n                fd.append(\"new-title\", rayv.currentItem.place_name);\n                fd.append(\"address\", rayv.currentItem.address);\n                fd.append(\"myComment\", rayv.currentItem.descr);\n                fd.append(\"latitude\", rayv.currentItem.position.lat);\n                fd.append(\"longitude\", rayv.currentItem.position.lng);\n                fd.append(\"voteScore\", rayv.currentItem.vote);\n                fd.append(\"website\", rayv.currentItem.website);\n                fd.append(\"untried\", 'untried' in rayv.currentItem ?\n                    rayv.currentItem.untried : false);\n                fd.append(\"rotation\", rayv.currentItem.rotation);\n                fd.append(\"key\", rayv.currentItem.key);\n                return fd;\n            }\n\n            /**\n             * save with an image upload\n             */\n            function saveMultiPart() {\n                var _URL;\n                console.log(\"With file\");\n                // to trigger a reload, make it different\n                rayv.currentItem.img = true;\n                // if a file is present\n                //     resize it\n                //     multipart form with image upload\n                var img = new Image();\n                //_URL = window.URL || window.webkitURL;\n                img.onload = function () {\n                    canvasResize(file, {\n                        width: 288,\n                        height: 0,\n                        crop: false,\n                        quality: 80,\n                        callback: function (data, width, height) {\n                            // Create a new form-data\n                            // Add file data\n                            var f = canvasResize('dataURLtoBlob', data);\n                            f.name = file.name;\n                            var fd = build_form(f);\n                            var xhr = new XMLHttpRequest();\n                            xhr.open('POST', '/item', true);\n                            xhr.setRequestHeader(\"X-Requested-With\",\n                                \"XMLHttpRequest\");\n                            xhr.setRequestHeader(\"pragma\", \"no-cache\");\n                            // File uploaded\n                            xhr.addEventListener(\"load\", function (res) {\n                                // clear the form as per #86\n                                $('#new-shout-form')[0].reset();\n                                BB.hide_waiting();\n                                $.mobile.changePage(\"#list-page\");\n                                rayv.currentItem.key = res;\n                                if (BB.updateCurrentItemInCache()) {\n                                    BB.populateMainList(\"\");\n                                }\n                                else {\n                                    BB.loadUserData();\n                                }\n                            });\n                            // Send data\n                            xhr.send(fd);\n                        }\n\n                    });\n                };\n                _URL = window.URL || window.webkitURL;\n                img.src = _URL.createObjectURL(file);\n            }\n\n            /**\n             * save with no image upload\n             */\n            function saveSinglePart() {\n                // no photo attached\n                // simple post, no upload\n                $.ajax({\n                    url: '/item',\n                    data: build_form(null),\n                    cache: false,\n                    contentType: false,\n                    processData: false,\n                    type: 'POST',\n                    success: function (res) {\n                        var it = JSON.parse(res);\n                        BB.set_distance_for_place(it);\n                        rayv.UserData.places.set(it.key, it);\n                        rayv.currentItem.loadFromKey(it.key);\n                        $.mobile.changePage(\"#list-page\");\n                        if (BB.updateCurrentItemInCache()) {\n                            BB.populateMainList(\"\");\n                        }\n                        else {\n                            BB.loadUserData();\n                        }\n                    },\n                    error: function () {\n                        BB.hide_waiting();\n                    }\n                });\n                console.log(\"AJAX saverayv.currentItem\");\n            }\n\n            if (file) {\n                saveMultiPart();\n            }\n            else {\n                saveSinglePart();\n            }\n        },\n\n        /**\n         * set the position of the item, then save it\n         * @param position {LatLng}\n         */\n        saveItemAtPos: function (position) {\n            console.log(\"saveItemAtPos\");\n            rayv.currentItem.position = position;\n            BB.saveCurrentItem();\n        },\n\n        /**\n         * remove all map markers\n         */\n        clearMapMarkers: function () {\n            //todo: markers?\n            if (BB.marker) {\n                BB.marker.setMap(null);\n            }\n            BB.mapMarkers.forEach(function (marker) {\n                marker.setMap(null);\n            });\n            BB.mapMarkers = [];\n        },\n\n//todo: is this the right name?\n        /**\n         *\n         * @param place_name {string}\n         * @param posn {LatLng}\n         */\n        loadMapItemForEdit: function (place_name, posn) {\n            console.log('loadMapItemForEdit');\n            $('#new-item-votes').find('li').removeClass('ui-btn-hover-b').\n                addClass('ui-btn-up-b').removeClass('ui-btn-active');\n            $('#new-item-like').addClass('ui-btn-active');\n            $(\"#new-category\").val('');\n            $(\"#cuisine-lookup\").hide();\n            $(\"#new-title-hdg\").text(place_name);\n            $(\"input[name=new-title]\").val(place_name);\n            $(\"#new-text\").val(\"\");\n            BB.saveItemAtPos(posn)\n        },\n\n        /**\n         * sprintf type {1}, {2} etc\n         * arg list of values\n         * @returns {string}\n         */\n        format: function () {\n            var s = arguments[0];\n            for (var i = 0; i < arguments.length - 1; i++) {\n                var reg = new RegExp(\"\\\\{\" + i + \"\\\\}\", \"gm\");\n                s = s.replace(reg, arguments[i + 1]);\n            }\n\n            return s;\n        },\n\n        /**\n         * setup a list of places\n         * @param UIlist {string} list selector #map-list or #main-list\n         * @returns {*}\n         */\n        setupList: function (UIlist) {\n            console.log('setupList');\n            $(UIlist).find('li').remove();\n            if (BB.isMapPage()) {\n                BB.clearMapMarkers();\n            }\n            var placeList = [];\n\n            var votes = rayv.UserData.myBook.get().votes;\n            for (var it in votes) {\n                //noinspection JSUnfilteredForInLoop\n                if ((BB.filter != 'untried') || (BB.filter == 'untried' &&\n                    votes[it].untried))\n                    placeList.push(it);\n            }\n            if (BB.filter == \"all\") {\n                //add the other lists\n                rayv.UserData.friends.forEach(function (friend) {\n                    for (it in friend.votes) {\n                        //noinspection JSUnfilteredForInLoop\n                        if (placeList.indexOf(it) == -1) {\n                            placeList.push(it)\n                        }\n                    }\n                });\n            }\n            var detailList = [];\n            placeList.forEach(function (place) {\n                var geoPt = rayv.UserData.places.get(place);\n                detailList.push(geoPt);\n            });\n\n            function compare_by_distance(a, b) {\n                if (a.dist_float < b.dist_float)\n                    return -1;\n                if (a.dist_float > b.dist_float)\n                    return 1;\n                return 0;\n            }\n\n            function compare_by_map_distance(a, b) {\n                if (a.map_dist_float < b.map_dist_float)\n                    return -1;\n                if (a.map_dist_float > b.map_dist_float)\n                    return 1;\n                return 0;\n            }\n\n            if (BB.isMapPage()) {\n                detailList.sort(compare_by_map_distance);\n                console.log(\"list sorted by map distance\")\n            }\n            else {\n                detailList.sort(compare_by_distance);\n                console.log(\"list sorted by gps distance\")\n            }\n\n\n            function inner_setup_list() {\n                console.log(\"inner_setup_list\");\n                $(UIlist).find('li').remove();\n                // marker for us\n                BB.marker = new google.maps.Marker({\n                    position: BB.lastGPSPosition.googleFormat(),\n                    map: BB.theMap,\n                    icon: BB.iconPath + \"blue_dot.png\"\n                    //infoWindowIndex: geoPtIdx\n                });\n                BB.mapMarkers.push(BB.marker);\n                for (var geoPtIdx  in detailList) {\n                    //noinspection JSUnfilteredForInLoop\n                    var geoPt = detailList[geoPtIdx],\n                        newListItem,\n                        click_fn,\n                        newListItemEnd;\n                    if (geoPt.is_map) {\n                        // it's a google place result - place_name, lat, long\n                        newListItem = templates.render(\n                            'list-geo-item-template',\n                            {'geoPt': geoPt}\n                        );\n                    }\n                    else {\n                        // it's a db item\n\n                        var context = { pt: geoPt, isMap: BB.isMapPage() };\n                        if (geoPtIdx < 6 && BB.isMapPage()) {\n                            context.icon = Number(geoPtIdx) + 1;\n                        }\n                        // https://github.com/adammark/Markup.js/\n                        newListItem = templates.render(\n                            'list-item-template',\n                            context);\n                    }\n                    UIlist.append(newListItem);\n\n                    //todo: infoWindow?\n                    if (BB.isMapPage() && (geoPtIdx < 7)) {\n                        var n = Number(geoPtIdx) + 1;\n                        var marker = new google.maps.Marker({\n                            position: new google.maps.LatLng(\n                                geoPt.lat, geoPt.lng),\n                            map: BB.theMap,\n                            title: geoPt.place_name,\n                            icon: BB.iconPath + n + \".png\",\n                            key: geoPt.key\n                        });\n                        BB.mapMarkers.push(marker);\n                        google.maps.event.addListener(marker, 'click',\n                            function () {\n                                //todo: what this?\n                                if (this.key) {\n                                    rayv.currentItem.loadFromKey(this.key);\n                                    BB.showAnotherItemOnMap();\n                                }\n                            }\n                        );\n                        /*var infoWindow = new google.maps.InfoWindow({\n                         content: geoPt.title\n                         });\n                         BB.mapInfoWindows.push(infoWindow);*/\n                    }\n                }\n                $(UIlist).find(\"A\").on(\"click\", BB.ItemLoadPage);\n                \n                //FLIGHT\n                // Get cached thumbs\n                rayv.UserData.getThumbs(UIlist);\n                try {\n                    $(UIlist).find('div[data-role=collapsible]').collapsible();\n                    try {\n                        UIlist.listview().listview('refresh');\n                        UIlist.trigger('updatelayout');\n                    } catch (e) {\n                    }\n                }\n                catch (e) {\n                    BB.log(e);\n                }\n                return UIlist;\n            }\n\n            return inner_setup_list();\n        },\n\n        /**\n         * are we on the Map page?\n         * @returns {boolean}\n         */\n        isMapPage: function () {\n            try {\n                return $.mobile.activePage.attr(\"id\") == \"map-page\";\n            }\n            catch (e) {\n                return false\n            }\n        },\n\n\n//Load Data\n\n\n        /**\n         * Error handler if we didnt get the list data\n         * from loadLocalPlaces()\n         * @param data {object} server return value\n         */\n        populateMainListError: function (data) {\n            console.log(\"populateMainListError\");\n            if (data.status == 401) {\n                $.mobile.changePage(\"#login-page\");\n            }\n            $(\"#new-place-list-loading\").hide();\n            $(\"#map-list-loading\").hide();\n            BB.navBarEnable();\n            $(\"#splash\").hide();\n        },\n\n        /**\n         * populate the place list on main page\n         */\n        populateMainList: function () {\n            console.log(\"populateMainList\");\n            // if lat=0 & long=0 then we will use the map position, else GPS\n            if (!BB.splash) {\n                $(\"#list-loading\").show();\n            }\n            BB.navBarDisable();\n            var last = null;\n            if (BB.lastMapPosition)\n                if (BB.lastMapPosition.isSet) {\n                    last = BB.lastMapPosition.position.googleFormat();\n                    console.log(\n                            \"populateMainListSuccess set map to last\" +\n                            \" map position, lat: \" + last.lat());\n                }\n            if (!last) {\n                last = BB.lastGPSPosition.googleFormat();\n                console.log(\"populateMainListSuccess set map to last GPS \" +\n                    \"position, lat: \" + last.lat());\n            }\n            BB.theMap.setCenter(last);\n\n            // update points with distance\n            var map_centre = new rayv.LatLng(0, 0).\n                loadFromGoogleFormat(BB.theMap.getCenter());\n            console.log(\"distances from Map: \" +\n                map_centre.lat + \", \" +\n                map_centre.lng);\n            rayv.UserData.places.forEach(function (place) {\n                var dist = BB.approx_distance(place, BB.lastGPSPosition);\n                place.distance = BB.pretty_dist(dist);\n                place.dist_float = dist;\n                var map_centre_dist = BB.approx_distance(place, map_centre);\n                place.map_dist_float = map_centre_dist;\n                place.map_distance = BB.pretty_dist(map_centre_dist);\n            });\n            BB.navBarEnable();\n\n            if (BB.isMapPage()) {\n\n                console.log(\"populateMainListSuccess set\");\n                BB.setupList($(\"#map-list\"));\n                $(\"#map-list-loading\").hide();\n            }\n            else {\n                $(\"#main-search\").val(\"\");\n                BB.setupList($(\"#main-list\"));\n                $(\"#list-loading\").hide();\n            }\n            $(\"#splash\").hide();\n            BB.splash = false;\n            try {\n                $('div[data-role=listview]').listview().listview('refresh').\n                    trigger('updatelayout');\n            } catch (e) {\n            }\n\n        },\n\n        cuisine_load_categories: function () {\n            if (BB.cuisine_categories) {\n                console.info('cuisine_load_categories');\n                return;\n            }\n            console.info('cuisine_load_categories Loading...');\n            BB.cuisine_categories = [];\n            $.get('/getCuisines_ajax',\n                {},\n                function (data) {\n                    var obj = jQuery.parseJSON(data);\n                    for (var idx = 0; idx < obj.categories.length; idx++) {\n                        BB.cuisine_categories.push(obj.categories[idx])\n                    }\n                    console.info('cuisine_load_categories Loaded');\n                })\n        },\n\n        cuisine_setup_categories_picker: function () {\n            console.info('cuisine_setup_categories_picker');\n            if ($(\"#new-category-list\").find('a').length > 0) {\n                return;\n            }\n            var group = $(\"#new-category-list\"),\n                $el;\n            group.controlgroup();\n            for (var idx = 0; idx < BB.cuisine_categories.length; idx++) {\n                $el = $(\"<a href='#'>\" +\n                    BB.cuisine_categories[idx] +\n                    \"</a>\").bind(\"click\", BB.cuisine_lookup_click);\n                group.controlgroup(\"container\")[\"append\"]($el);\n                $el.buttonMarkup();\n            }\n            group.controlgroup(\"refresh\");\n            if (rayv.currentItem.category) {\n                $('#new-category-list').hide();\n            }\n            else {\n                $('#new-category-list').show();\n            }\n        },\n\n        cuisine_show_all_options: function () {\n            var lookup = $('#new-category-list');\n            lookup.show();\n            lookup.find('a').each(function () {\n                $(this).show();\n            });\n        },\n\n        cuisine_keyup: function () {\n            var text = $('#new-category').val().toLowerCase();\n            var lookup = $('#new-category-list');\n            lookup.show();\n            lookup.find('a').each(function () {\n                if ($(this).text().toLowerCase().indexOf(text) > -1) {\n                    $(this).show();\n                }\n                else {\n                    $(this).hide();\n                }\n            });\n        },\n\n        cuisine_lookup_click: function () {\n            console.log('cuisine_lookup_click');\n            $('#new-category').val($(this).text());\n            $('#new-category-list').hide();\n        },\n\n        set_edit_page_category: function () {\n            console.log('set_edit_page_category = ' + rayv.currentItem.category);\n            $(\"#new-category\").val(rayv.currentItem.category);\n            if (rayv.currentItem.category) {\n                $(\"#cuisine-lookup\").hide();\n            }\n            BB.cuisine_setup_categories_picker()\n        },\n\n        /**\n         * Click handler for the list of places on the Add page\n         * @param event {event}\n         */\n        new_places_list_click: function (event) {\n            console.log(\"new_places_list_click\");\n            //user clicked on a place (or db entry) in the new Shout page\n            if ($(this).data(\"shoutIsMap\")) {\n                // it's a map item\n                //copy the text from the <a> tag to the text box on the\n                // New Item page\n                var text = $(this).find(\".list-item-title\").text().trim();\n                $(\"#new-detail-name\").val(text);\n                $(\"input[name=new-title]\").val(text);\n                rayv.currentItem.place_name = text;\n                rayv.currentItem.address = $(this).data(\"address\");\n                rayv.currentItem.descr = \"\";\n                rayv.currentItem.category = $(this).data(\"category\");\n                $(\"#new-detail-address\").val(rayv.currentItem.address);\n                // no comment as it's not in db\n                $(\"#new-detail-comment\").val(\"\");\n                BB.set_edit_page_category();\n                rayv.currentItem.key = $(this).data(\"shoutKey\");\n                console.log(\"key set new_places_list_click\");\n                rayv.currentItem.position = new rayv.LatLng(\n                    $(this).data(\"lat\"),\n                    $(this).data(\"lng\"));\n            }\n            else {\n                //new place from scratch\n                var place = $(\"#new-place-name-box\").val();\n                if (place.length < 2) {\n                    alert(\"You need to enter a name\");\n                    event.preventDefault();\n                    return false;\n                }\n                else {\n                    $(\"#new-title-hdg\").text(place);\n                    rayv.currentItem.place_name = place;\n                    $(\"input[name=new-title]\").val(rayv.currentItem.place_name);\n                    rayv.currentItem.key = \"\";\n                    console.log(\"key set new_places_list_click 2\");\n                    //TODO: What does it mean when the lat and long is zero?\n\n                    //todo: what's the address?\n                    rayv.currentItem.address = \"\";\n                    BB.set_edit_page_category();\n                }\n                $.mobile.changePage(\"#new-detail\");\n            }\n            // go to the page\n        },\n\n        set_distance_for_place: function (pt) {\n            var posn = new rayv.LatLng(pt.lat, pt.lng);\n            pt.dist_float = BB.approx_distance(\n                posn,\n                BB.lastGPSPosition);\n            var dist_str = BB.pretty_dist(pt.dist_float);\n            pt.distance = dist_str;\n        }, /**\n         * ajax callback on loaded list of possible places to Add\n         * @param data {object} server data\n         */\n        loadPlacesListSuccessHandler: function (data) {\n            console.log(\"loadPlacesListSuccessHandler\");\n            var obj = $.parseJSON(data);\n            var pts = obj.local.points;\n            for (var idx = 0; idx < pts.length; idx++) {\n                var pt = pts[idx];\n                BB.set_distance_for_place(pt);\n            }\n            pts.sort(function (a, b) {\n                return a.dist_float - b.dist_float\n            });\n            var el = $(\"#new-place-list\");\n            el.html(templates.render(\n                'new-place-list-js',\n                {'points': obj.local.points}));\n            el.trigger(\"create\");\n            el.find(\"ul\").find(\"a\").on(\"click\", BB.new_places_list_click);\n            BB.navBarEnable();\n            $(\"#new-place-list-loading\").hide();\n        },\n\n\n        navBarDisable: function () {\n            BB.navBarActive = false;\n        },\n\n        navBarEnable: function () {\n            BB.navBarActive = true;\n        },\n\n        /**\n         * load the list of local places for Add New\n         * @param search_text {string}\n         */\n        loadLocalPlaces: function (search_text) {\n            // this is for the \"new place\" page list -\n            //  from google maps and from my db\n            console.log(\"loadLocalPlaces\");\n            var request = {};\n            $(\"#new-place-list-loading\").show();\n            console.log(\"AJAX gotPositionForPlaces\");\n            BB.navBarDisable();\n            request.lat = BB.lastGPSPosition.lat;\n            request.lng = BB.lastGPSPosition.lng;\n            request.text = search_text;\n            $.ajax({\n                url: \"/getMapList_Ajax\",\n                type: \"GET\",\n                data: request,\n                handleAs: \"json\",\n                success: BB.loadPlacesListSuccessHandler,\n                error: BB.populateMainListError\n            });\n        },\n\n        /**\n         * save the item being edited\n         */\n        new_item_save_click: function () {\n            // save a new item\n            //called from new-detail-page\n            if (BB.detail_saving) {\n                console.log(\"new_item_save_click ignored\");\n                return;\n            }\n            console.log(\"new_item_save_click\");\n            var hasVote = false;\n            rayv.currentItem.untried = false;\n            rayv.currentItem.vote = 1;\n            if ($('#new-item-dislike').hasClass('ui-btn-active')) {\n                rayv.currentItem.vote = -1;\n                rayv.currentItem.untried = false;\n                hasVote = true;\n            }\n            if ($('#new-item-untried').hasClass('ui-btn-active')) {\n                rayv.currentItem.untried = true;\n                rayv.currentItem.vote = 0;\n                hasVote = true;\n            }\n            if ($('#new-item-like').hasClass('ui-btn-active')) {\n                hasVote = true;\n            }\n            if (!hasVote) {\n                alert('Please vote!');\n                return;\n            }\n\n            BB.show_waiting(\"#details-save-waiting\");\n\n            //rayv.currentItem.descr = $(\"#new-detail-comment\").val();\n            rayv.currentItem.category = $(\"#new-category\").val();\n            if (!rayv.currentItem.category) {\n                alert(\"You must pick a type of cuisine\");\n                BB.detail_saving = false;\n                return;\n            }\n            rayv.currentItem.address = $(\"#new-detail-address\").val();\n            rayv.currentItem.place_name = $(\"#new-detail-name\").val();\n            rayv.currentItem.descr = $(\"#new-detail-comment\").val();\n\n            if (rayv.currentItem.key == \"\") {\n                //from map or db, use supplied pos\n                var pos = rayv.currentItem.position;\n                BB.saveItemAtPos(pos);\n            }\n            else {\n                BB.saveCurrentItem();\n            }\n        },\n\n\n        /**\n         * load the votes from friends into the UL on the detail page\n         */\n        loadVotes: function () {\n            var votes = [];\n            rayv.UserData.friends.forEach(function (friend) {\n                for (var key in friend.votes) {\n                    //noinspection JSUnfilteredForInLoop\n                    var vote = friend.votes[key];\n                    if (vote == rayv.currentItem.key) {\n                        vote.userName = friend.name;\n                        votes.push(vote)\n                    }\n                }\n            });\n            var context = { votes: votes };\n            // https://github.com/adammark/Markup.js/\n            var newVoteList = templates.render('item-votes-list', context);\n            $(\"#item-votes-list-container\").html(newVoteList);\n            $(\"#item-votes\").trigger(\"create\");\n            $(\"#item-votes-collapsible\").show();\n        },\n\n        /**\n         *  click handler for item save button\n         */\n        updateitem: function () {\n            console.log(\"updateitem\");\n            rayv.currentItem.descr = $(\"#item-descr\").val();\n            rayv.currentItem.vote = null;\n            rayv.currentItem.untried = false;\n            if ($('#item-dislike').hasClass('ui-btn-active')) {\n                rayv.currentItem.vote = -1;\n            }\n            else if ($('#item-like').hasClass('ui-btn-active')) {\n                rayv.currentItem.vote = 1;\n            }\n            else if ($('#item-untried').hasClass('ui-btn-active')) {\n                rayv.currentItem.untried = true;\n                rayv.currentItem.vote = 0;\n            }\n            if (!$.isNumeric(rayv.currentItem.vote)) {\n                alert('You need to vote');\n                return;\n            }\n            BB.saveCurrentItem();\n        },\n\n        /**\n         * on change event for the new place lookup\n         */\n        place_search_by_name: function () {\n            // hide all items\n            // now show those containing our text\n            var search_for = $(\"#new-place-name-box\").val();\n            var el = $(\"#new-place-list\").children(\"ul\");\n            if (search_for.length > 0) {\n                el.children(\"li\").hide();\n                el.children(\"li:\" + \"contains('Add New')\").show();\n                el.children('li:contains(\"' + search_for + '\")').show();\n            }\n            else {\n                el.children('li').show();\n            }\n        },\n\n        /**\n         * on change event for the new place lookup\n         */\n        list_text_filter: function () {\n            console.log('list_text_filter');\n            var search_for = $(\"#main-search\").val();\n            if (search_for.length > 0) {\n                // hide all items\n                var list = $(\"#main-list\");\n                list.children(\"li\").hide();\n                // now show those containing our text\n                list.children('li:contains(\"' + search_for + '\")').\n                    show();\n            }\n            else {\n                $(\"#main-list\").children(\"li\").show();\n            }\n        },\n\n        /**\n         * copy details from the Item page to the New Item age to edit them\n         */\n        page_to_edit_item: function () {\n            // copy over the vals from the item page\n            //todo: check for new Item path\n            console.log(\"cat: \" + $(\"#item-category\").val());\n            rayv.currentItem.loadFromKey();\n            var myBook = rayv.UserData.myBook.get();\n            if (rayv.currentItem.key in myBook.votes) {\n                $(\"#new-item-delete\").show();\n            }\n            else {\n                $(\"#new-item-delete\").hide();\n            }\n            $(\"#new-detail-name\").val(rayv.currentItem.place_name);\n            $(\"#new-detail-address\").val(rayv.currentItem.address);\n            BB.set_edit_page_category();\n            // add my comment if there is one\n            if (myBook.votes[rayv.currentItem.key]) {\n                $(\"#new-detail-comment\").val(\n                    myBook.votes[rayv.currentItem.key].comment);\n            }\n            ;\n            //set the likes radio\n            if (rayv.currentItem.untried) {\n                $('#new-item-votes li').\n                    removeClass('ui-btn-hover-b').\n                    addClass('ui-btn-up-b').\n                    removeClass('ui-btn-active');\n                $('#new-item-untried').addClass('ui-btn-active');\n            }\n            else {\n                if (rayv.currentItem.vote >= 0) {\n                    $('#new-item-votes').find('li').\n                        removeClass('ui-btn-hover-b').\n                        addClass('ui-btn-up-b').\n                        removeClass('ui-btn-active');\n                    $('#new-item-like').addClass('ui-btn-active');\n                }\n                else {\n                    $('#new-item-votes').\n                        find('li').\n                        removeClass('ui-btn-hover-b').\n                        addClass('ui-btn-up-b').\n                        removeClass('ui-btn-active');\n                    $('#new-item-dislike').addClass('ui-btn-active');\n                }\n            }\n            $(\"#new-preview-box\").\n                children(\"div\").\n                children(\"img\").\n                removeClass(\"rotr\").\n                removeClass(\"rotu\").\n                removeClass(\"rotl\");\n            BB.imageRotation = 0;\n            if (rayv.currentItem.img) {\n                console.log(\"Show item image\");\n                $(\"#new-preview-box\").show();\n                var el = $(\"#new-img\").children(\"img\");\n                el.attr(\"src\", rayv.currentItem.img);\n                el.attr(\"style\", \"\");\n                $(\"#new-img\").show();\n            }\n            else {\n                $(\"#new-img\").hide();\n            }\n        },\n\n\n        /**\n         * map-search key press event\n         * @param e {event}\n         */\n        map_search_key: function (e) {\n            var el = $(\"#map-search\");\n            if (el.val().length == 0) {\n                $(\"#googlemapsjs1\").show();\n                $(\"#map-search-btn-box\").hide();\n            } else\n                $(\"#map-search-btn-box\").show();\n            // if it's return do the search\n            if (e.which == 13 || (e.which == 8 && el.val().length == 0 )) {\n                console.log(\"map_search_key: 13\");\n                $(\"#googlemapsjs1\").hide();\n                //hide keyboard\n                document.activeElement.blur();\n                $(\"#map-search-btn\").hide();\n                $(\"input\").blur();\n                //load results\n                BB.populateMainList($(\"#map-search\").val());\n                $(\"#map-list-loading\").show();\n            }\n        },\n\n\n        /**\n         * show the map page, centered on the current item\n         */\n        showItemOnMap: function () {\n            BB.lastMapPosition.position = rayv.currentItem.position;\n            google.maps.event.trigger(BB.theMap, 'resize');\n            BB.lastMapPosition.isSet = true;\n            BB.lastMapPosition.zoomIn = true;\n            $.mobile.changePage(\"#map-page\");\n        },\n\n        /**\n         * open the web page associated with the place\n         */\n        showItemWebPage: function () {\n            window.location = rayv.currentItem.website;\n        },\n\n        /**\n         * center map on the current item\n         * called on marker click\n         */\n        showAnotherItemOnMap: function () {\n            BB.lastMapPosition.position = rayv.currentItem.position;\n            BB.populateMainList(\"\");\n            BB.lastMapPosition.isSet = true;\n            BB.lastMapPosition.zoomIn = false;\n            BB.pageToMap();\n        },\n\n        /**\n         * redo distances and order on map drag\n         */\n        dragMap: function () {\n            // centered on the map\n            BB.lastMapPosition.position =\n                new rayv.LatLng(0, 0).loadFromGoogleFormat(BB.theMap.getCenter());\n            BB.populateMainList(\"\");\n            BB.lastMapPosition.isSet = true;\n            BB.lastMapPosition.zoomIn = false;\n            BB.map_centred = false;\n            BB.pageToMap();\n        },\n\n        /**\n         * work out image rotation change on details page\n         * @param e {event}\n         */\n        imageRotate: function (e) {\n            e.preventDefault();\n            BB.imageRotation = (BB.imageRotation + 1) % 4;\n            var img = $(\"#new-preview-box\").children(\"div\").children(\"img\");\n            switch (BB.imageRotation) {\n                case 0:\n                    //original\n                    img.removeClass(\"rotr\").\n                        removeClass(\"rotu\").\n                        removeClass(\"rotl\");\n                    rayv.currentItem.rotation = 0;\n                    break;\n                case 1:\n                    //right\n                    img.removeClass(\"rotl\").\n                        removeClass(\"rotu\").\n                        addClass(\"rotr\");\n                    rayv.currentItem.rotation = 1;\n                    break;\n                case 2:\n                    // invert\n                    img.removeClass(\"rotl\").\n                        removeClass(\"rotr\").\n                        addClass(\"rotu\");\n                    rayv.currentItem.rotation = -2;\n                    break;\n\n                case 3:\n                    //left\n                    img.removeClass(\"rotr\").\n                        removeClass(\"rotu\").\n                        addClass(\"rotl\");\n                    rayv.currentItem.rotation = -1;\n                    break;\n\n            }\n        },\n\n\n        pageToList: function (event) {\n            console.log(\"PAGE list\");\n\n            if (BB.navBarActive) {\n\n                BB.populateMainList(\"\");\n                $(\"#list-loading\").hide();\n            }\n            else\n                event.preventDefault();\n        },\n\n        imagePreview: function () {\n            var oFReader = new FileReader();\n            try {\n                //todo: what this?\n                oFReader.readAsDataURL(this.files[0]);\n            }\n            catch (e) {\n                $('#image-dialog').popup('close')\n            }\n            console.log(this.files[0]);\n            oFReader.onload = function (oFREvent) {\n                var img = $(\"#new-preview-box\").children(\"div\").children(\"img\");\n                img.html(\n                        '<img height=\"150\" ' +\n                        'id=\"new-image\" ' +\n                        'data-inline=\"true\" ' +\n                        'src=\"' + oFREvent.target.result + '\">');\n                $('#new-preview-box').show();\n                img.attr('src', oFREvent.target.result);\n                // show the preview\n                $(\"#new-img\").show();\n                try {\n                    $('#image-dialog').popup('close')\n                } catch (e) {\n                }\n            };\n\n        },\n\n\n        pageToMap: function () {\n            console.log(\"PAGE map\");\n            if (BB.navBarActive) {\n                $(\"#map-list-loading\").show();\n                $(\"#map-search-btn\").hide();\n                $(\"#map-search\").val(\"\");\n                var last;\n                if (BB.lastMapPosition.isSet) {\n                    last = BB.lastMapPosition.position.googleFormat();\n                    console.log(\"set map to last position, lat: \" + last.lat());\n                    try {\n                        BB.theMap.setCenter(last);\n                        BB.map_centred = false;\n                        console.log(\n                                \"set map (1) to last position, lat: \" +\n                                last.lat());\n                        if (BB.lastMapPosition.zoomIn) {\n                            BB.theMap.setZoom(18);\n                            BB.lastMapPosition.zoomIn = false;\n                        }\n                    }\n                    catch (e) {\n                        console.log(\"MAIN MAP NOT SET\")\n                    }\n                } else {\n                    last = BB.lastGPSPosition.googleFormat();\n                    console.log(\"set map (2) to last position, lat: \" +\n                        last.lat());\n                    try {\n                        BB.theMap.setCenter(last);\n                        if (BB.lastMapPosition.zoomIn) {\n                            BB.theMap.setZoom(18);\n                            BB.lastMapPosition.zoomIn = false;\n                        }\n                    }\n                    catch (e) {\n                        console.log(\"MAIN MAP NOT SET\")\n                    }\n                }\n                /*BB.marker = new google.maps.Marker({\n                 position: last,\n                 map: BB.theMap,\n                 title: 'Hello World!'\n                 });*/\n                google.maps.event.trigger(BB.theMap, 'resize');\n                BB.populateMainList(\"\");\n            }\n            else\n                event.preventDefault();\n        },\n\n        pageToNewPlace: function (event, previousPage) {\n            console.log(\"PAGE new place\");\n            if (BB.navBarActive) {\n                $('#new-preview-box').hide();\n                $(\"#new-place-near\").hide();\n                $(\"#new-search-place-btn\").hide();\n                if (previousPage == \"new-detail\") {\n                    //don't reload\n                    console.log(\"PAGE new place - no reload\")\n                }\n                else {\n                    BB.loadLocalPlaces(null);\n                    $(\"input[name=new-title]\").val(\"\");\n                }\n            }\n            else\n                event.preventDefault();\n        },\n\n        pageToImage: function () {\n            $(\"#image-img\").children(\"img\").attr(\"src\", rayv.currentItem.img);\n            $(\"#image-header\").text(rayv.currentItem.place_name);\n        },\n\n        ItemLoadPage: function () {\n            console.log('ItemLoadPage');\n            rayv.currentItem.key = $(this).data('key');\n            console.log(\"key set ItemLoadPage\");\n            $.mobile.changePage(\"#item-page\")\n        },\n\n        dragCreatorMap: function () {\n            //put & keep marker at centre\n            if (BB.creatorMapMarker) {\n                BB.creatorMapMarker.setMap(null);\n                BB.creatorMapMarker = null;\n            }\n            BB.creatorMapMarker = new google.maps.Marker({\n                position: BB.creatorMap.getCenter(),\n                map: BB.creatorMap,\n                icon: BB.iconPath + \"pointer.png\"\n                //infoWindowIndex: geoPtIdx\n            });\n            //lookup nearest address\n            BB.codeLatLng();\n\n        },\n        pageToCreateAddress: function () {\n            //init map\n            if (!BB.creatorMap) {\n                var mapOptions = {\n                    zoom: 15,\n                    center: BB.lastGPSPosition.googleFormat()\n                };\n                BB.creatorMap = new google.maps.Map(\n                    document.getElementById('find-on-map-div'),\n                    mapOptions);\n                google.maps.event.addListener(\n                    BB.creatorMap, 'dragend', BB.dragCreatorMap);\n            }\n            else {\n                BB.creatorMap.setCenter(\n                    BB.lastGPSPosition.googleFormat());\n            }\n            $(\"#create-name\").val($(\"#new-name\").val());\n            $(\"#dragged-address\").hide();\n            $(\"#create-new-save-btn\").addClass(\"ui-disabled\")\n        },\n\n        clearItemPage: function () {\n            $(\"#item-img\").children(\"img\").attr(\"src\", \"\");\n            $(\"#item-title\").html(\"Loading\");\n            $(\"#item-address\").html(\"\");\n\n            $(\"#item-category\").html(\"Loading\");\n            $(\"#item-phone-link\").hide();\n\n            $(\"#item-title-2\").html(\"Loading\");\n            $(\"#item-comments\").html(\"None\");\n\n            $(\"#item-distance\").html(\"\");\n\n            $(\"#item-delete\").hide();\n            $('#item-votes-inner').trigger('collapse').trigger('updatelayout');\n            $(\"#vote-cursor\").val(\"\");\n            $(\"#item-votes\").html(\"\");\n        },\n\n        pageToItem: function (event, previousPage) {\n            if (rayv.currentItem.key) {\n                console.log(\"pageToItem\");\n                //todo: check for new Item path\n                // if we have come from the image page,\n                // the image should be shown on the item page too\n                if (previousPage == \"image-page\")\n                    $(\"#item-img\").show();\n                //$(\"#item-img\").show();\n                rayv.currentItem.loadFromKey();\n                $(\"#item-title\").html(rayv.currentItem.place_name);\n                $(\"#item-address\").html(rayv.currentItem.address);\n                $(\"#item-category\").html(rayv.currentItem.category);\n                if (rayv.currentItem.telephone) {\n                    var phone = $(\"#item-phone-link\");\n                    phone.attr('href', 'tel:' + rayv.currentItem.telephone);\n                    phone.show();\n                }\n                else {\n                    $(\"#item-phone-link\").hide();\n                }\n                if (rayv.currentItem.website) {\n                    $(\"#item-web-link\").show();\n                }\n                else {\n                    $(\"#item-web-link\").hide();\n                }\n\n                $(\"#item-title-2\").html(rayv.currentItem.place_name);\n                var comment = rayv.UserData.get_my_comment(rayv.currentItem.key);\n                var comment_header = comment;\n\n                if (comment.length == 0) {\n                    comment_header = \"Friends' Comments / Tips\";\n                }\n\n                var $btn_text = $(\"#item-comment-btn\").\n                    find(\"a\").\n                    find(\".ui-btn-text\");\n                var $btn_child = $btn_text.find(\n                    '.ui-collapsible-heading-status');\n                //overwrite the header text, then append its\n                // child to restore the previous structure\n                $btn_text.text(comment_header).append($btn_child);\n\n                $(\"#item-descr\").val(comment);\n\n                // friends' comments\n                $(\"#item-comments\").html();\n                var votes = rayv.UserData.get_votes_for_item(\n                    rayv.currentItem.key);\n                var html = \"\";\n                votes.forEach(function (vote) {\n                    if (vote.vote.comment.length > 0) {\n                        html += templates.render('friend-comment-template', vote);\n                    }\n                });\n                $(\"#item-comments\").html(html);\n\n                $(\"#item-distance\").html(rayv.currentItem.distance);\n\n                //set the likes radio\n                $('#item-page-votes').find('li').find('a').removeClass('ui-btn-hover-b').\n                    addClass('ui-btn-up-b').removeClass('ui-btn-active');\n                if (rayv.currentItem.untried) {\n                    $('#item-untried').addClass('ui-btn-active');\n                }\n                else {\n                    var vote = rayv.currentItem.vote;\n                    if ($.isNumeric(vote)) {\n                        if (vote > 0) {\n                            $('#item-like').addClass('ui-btn-active');\n                        }\n                        else {\n                            $('#item-dislike').addClass('ui-btn-active');\n                        }\n                    }\n                }\n                var img = $(\"#item-img\");\n                if (rayv.currentItem.img) {\n                    console.log(\"Show item image\");\n                    img.show();\n                    img.children(\"img\").attr(\"src\", rayv.currentItem.img);\n                    img.children(\"img\").attr(\"style\", \"\");\n                }\n                else {\n                    //$(\"#item-img\").hide();\n                    img.children(\"img\").attr(\n                        \"src\", '/static/images/no-image.png');\n                    img.children(\"img\").attr(\"style\", \"\");\n                }\n                if (rayv.currentItem.key in rayv.UserData.myBook.get().votes) {\n                    $(\"#item-delete\").show();\n                }\n                else {\n                    $(\"#item-delete\").hide();\n                }\n                $('#item-votes-inner').\n                    trigger('collapse').\n                    trigger('updatelayout');\n                $(\"#vote-cursor\").val(\"\");\n                $(\"#item-votes\").html(\"\");\n                BB.loadVotes()\n            }\n        },\n\n        mapSearchClick: function () {\n            BB.map_search_key({\"which\": 13});\n        },\n\n        clickColumnHeader: function () {\n            // click a column header on the list page\n            BB.filter = BB.get_list_column_filter();\n            BB.populateMainList(\"\", 0, 0);\n        },\n\n// proper case function (JScript 5.5+)\n        toProperCase: function (s) {\n            return s.toLowerCase().replace(/^(.)|\\s(.)/g,\n                function ($1) {\n                    return $1.toUpperCase();\n                });\n        },\n\n        /**\n         * load a place for edit when it comes from a geo search on Add New\n         */\n        item_create: function () {\n            console.log('item_create');\n            var properTitle = BB.toProperCase($(this).data('title'));\n            $(\"#new-detail-name\").val(decodeURIComponent(properTitle));\n            $(\"#new-detail-address\").val($(this).data('address'));\n            $(\"#new-category\").val('');\n            BB.cuisine_setup_categories_picker();\n            $(\"#new-detail-comment\").val(\"\");\n\n            //set the likes radio\n            $(\"#new-detail-vote\").find(\"a\").\n                removeClass('ui-btn-hover-b').\n                addClass('ui-btn-up-b').\n                removeClass('ui-btn-active');\n            $('#new-item-like').addClass('ui-btn-active');\n            $(\"#new-preview-box\").hide();\n\n            rayv.currentItem.address = $(this).data('address');\n            rayv.currentItem.key = $(this).data('key');\n            rayv.currentItem.position = new rayv.LatLng(\n                $(this).data('lat'),\n                $(this).data('lng'));\n            rayv.currentItem.place_name = properTitle;\n        },\n\n        lookupAddressList: function (event) {\n            var addr;\n            $(\"#new-place-list-loading\").show();\n            function lookAddressList_inner(obj) {\n                try {\n\n                    BB.check_for_dirty_data(obj);\n\n                    //safe_title = .replace(/\\\"/g, \"&quot;\").replace(/\\'/g, \"&lsquo;\"),\n                    // https://github.com/adammark/Markup.js/\n//                    Add Distance\n//                    for (var plIdx=0; plIdx<obj.local.points.length; plIdx++){\n//                        var pt = obj.local.points[plIdx];\n//                        pt.distance = BB.approx_distance(\n//                            LatLng(pt.lat,pt.lng),\n//                            BB.lastGPSPosition)\n//                    }\n                    var context = {'items': obj.local.points};\n                    var UIlist = templates.render(\n                        'add-search-nearby-template',\n                        context);\n\n                    $(\"#new-place-list\").\n                        html(UIlist).listview().\n                        trigger('create').\n                        trigger('updatelayout');\n                    $(\".found-address\").on(\"click\", BB.item_create);\n                    $(\"#manual-address-lookup\").val(rayv.currentItem.address);\n                }\n                catch (e) {\n                    console.error(\"lookupAddressList\");\n                }\n                $(\"#new-place-list-loading\").hide();\n            }\n\n\n            function lookupAddressListSuccessHandler(data) {\n                $(\"#search-location-loading\").hide();\n                $(\"#new-place-list-loading\").hide();\n                //$.mobile.changePage(\"#new-address-list-page\");\n                $(\"#new-place\").find(\"ul\").remove();\n                lookAddressList_inner(jQuery.parseJSON(data));\n            }\n\n            function lookupAddressListErrorHandler() {\n                $(\"#search-location-loading\").hide();\n                $(\"#new-place-list-loading\").hide();\n                console.log(\"no address found\");\n                alert(\"Not Found\");\n                $(\"#new-page\").find(\"ul\").remove();\n                $(\"#create-new-address-box\").show();\n                // string to be parsed\n                lookAddressList_inner({items: []});\n            }\n\n            console.log(\"AJAX lookupAddressList\");\n            addr = rayv.currentItem.address;\n            var request = {};\n            request.lat = BB.lastGPSPosition.lat;\n            request.lng = BB.lastGPSPosition.lng;\n            request.addr = addr;\n            // get the place name from the new screen\n            request.place_name = $(\"#new-place-name-box\").val();\n            if (event.currentTarget.id == \"new-search-place-btn\") {\n                //near address\n                request.near_me = 0;\n            } else {\n                request.near_me = 1;\n            }\n            $(\"#search-location-loading\").show();\n            $.ajax({\n                url: \"/getAddresses_ajax\",\n                type: \"GET\",\n                handleAs: \"json\",\n                data: request,\n                success: lookupAddressListSuccessHandler,\n                error: lookupAddressListErrorHandler\n            });\n        },\n\n        lookupMyAddress: function (event) {\n            rayv.currentItem.address = \"\";\n            BB.lookupAddressList(event);\n        },\n\n        lookupManualAddress: function (event) {\n            rayv.currentItem.address = $(\"#new-place-near\").val();\n            BB.lookupAddressList(event);\n        },\n\n        add_search_name: function () {\n            //lookup a place by name in the add page\n            rayv.currentItem.place_name = $(\"#new-place-name-box\").val();\n        },\n\n        take_photo_click: function () {\n            try {\n                $('#image-dialog').popup('close');\n            }\n            catch (e) {\n                console.log(\"take_photo_click error: \" + e);\n            }\n            $(\"#image-input\").click();\n        },\n\n        open_image_file_click: function () {\n            try {\n                $('#image-dialog').popup('close');\n            }\n            catch (e) {\n                console.log(\"take_photo_click error: \" + e);\n            }\n            $(\"#file-input\").click();\n        },\n\n        editItem: function (event) {\n            console.log(\"editItem\");\n            event.preventDefault();\n            $.mobile.changePage(\"#new-detail\")\n        },\n\n        show_create_new_address: function () {\n            $.mobile.changePage(\"#create-new-address\");\n        },\n\n        do_create_new_address: function () {\n            var addr = $(\"#dragged-address\").text();\n            if (addr.length > 0) {\n                rayv.currentItem.clear();\n                rayv.currentItem.place_name = $(\"#create-name\").val();\n                rayv.currentItem.address = addr;\n                rayv.currentItem.position =\n                    new rayv.LatLng(0, 0).\n                        loadFromGoogleFormat(BB.creatorMap.getCenter());\n                BB.page_to_edit_item();\n                $.mobile.changePage(\"#new-detail\");\n            } else {\n                $(\"#create-new-save-btn\").addClass(\"ui-disabled\")\n            }\n\n        },\n\n//FLIGHT\n        offlineEventHandler: function () {\n            alert(\"This action requires an internet connection (3G/WiFi)\")\n        },\n\n\n//FLIGHT\n//test for online\n        checkOnline: function (callback) {\n            $.get(\"/ping\",\n                {},\n                function () {\n                    //ok\n                    console.log(\"ONLINE\");\n                    BB.isOnline = true;\n                    callback();\n                },\n                function () {\n                    //offline\n                    console.log(\"OFFLINE\");\n                    alert(\"Server not available. Functionality will be limited\");\n                    BB.isOnline = false;\n                    callback();\n                })\n        },\n\n        /**\n         * delete an item - means remove my vote for it\n         */\n        itemDelete: function () {\n            //delete the current item\n            //is it in my list?\n            if (rayv.currentItem.key in rayv.UserData.myBook.get().votes) {\n                if (confirm(\"Remove place from your list?\")) {\n                    $.ajax(\n                        {url: '/item/del/' + rayv.currentItem.key,\n                            type: 'post',\n                            success: function () {\n                                $.mobile.changePage(\"#list-page\");\n                                rayv.UserData.load(BB.populateMainList);\n                            }})\n                }\n            }\n        },\n\n        /**\n         * set the main list filter\n         * @param val\n         */\n        set_list_column_filter: function (val) {\n            var filter = $(\"#filter-radio\");\n            filter.find(\"input[type='radio']\").attr(\"checked\", null);\n            filter.find(\"input[type='radio'][value='\" + val + \"']\").attr(\n                \"checked\", \"checked\");\n            filter.find(\"input[type='radio']\").\n                checkboxradio().\n                checkboxradio(\"refresh\");\n        },\n\n        /**\n         * Which filter is selected for the main list?\n         * @returns {string} the name of the filter\n         */\n        get_list_column_filter: function () {\n            return $(\"#filter-radio\").find(\"input:checked\").val();\n        },\n\n        set_test_location: function () {\n            if ($(this).val() == 'on') {\n                BB.use_test_location = true;\n                BB.test_lat = parseFloat($(\"#test-lat\").val());\n                BB.test_lng = parseFloat($(\"#test-lng\").val());\n                BB.lastGPSPosition = new rayv.LatLng(\n                    BB.test_lat,\n                    BB.test_lng);\n            }\n            else {\n                BB.use_test_location = false;\n            }\n        },\n\n\n        /**\n         * check comment has no more characters than allowed (140)\n         * on details page\n         */\n        comment_validate: function () {\n            var text = $(this).val();\n            var chars = text.length;\n            //check if there are more characters than allowed (140)\n            if (chars > 140) {\n                //and if there are use substr to get the text before the limit\n                var new_text = text.substr(0, 140);\n                //and change the current text with the new text\n                $(this).val(new_text);\n            }\n        },\n\n        /**\n         * got gps pos\n         * @param pos\n         */\n        watchPositionSuccess: function (pos) {\n            console.log(\"watchPositionSuccess: \" +\n                pos.coords.latitude + \",\" +\n                pos.coords.longitude);\n            BB.lastGPSPosition = new rayv.LatLng(\n                pos.coords.latitude,\n                pos.coords.longitude);\n            var now = new Date();\n            if (now - BB.lastGPSTime > (2 * BB.watchPositionOptions.maximumAge)) {\n                BB.watch_position_id = navigator.geolocation.watchPosition(\n                    BB.watchPositionSuccess,\n                    BB.watchPositionError,\n                    BB.watchPositionOptions);\n            }\n            BB.lastGPSTime = now;\n            if (BB.isMapPage() && BB.map_centred) {\n                BB.map_center();\n            }\n        },\n\n        /**\n         * couldn't get gps\n         * @param err\n         */\n        watchPositionError: function (err) {\n            console.warn(\n                    'watchPositionError ERROR(' +\n                    err.code + '): ' +\n                    err.message);\n            navigator.geolocation.getCurrentPosition(\n                BB.firstWatchPositionSuccess,\n                BB.watchPositionError,\n                BB.watchPositionOptions);\n        },\n\n        /**\n         * got first gps pos\n         * @param pos\n         */\n        firstWatchPositionSuccess: function (pos) {\n            BB.watchPositionSuccess(pos);\n            BB.init();\n            BB.loadUserData();\n        },\n\n        /**\n         * save user profile\n         */\n        save_profile: function () {\n            $.post(\n                '/user_profile',\n                {'screen_name': $('#settings-screen-name').val()},\n                function (data) {\n                    alert('Saved');\n                });\n        },\n\n        /**\n         * for Add New - search near a place, show the box to type it in\n         */\n        set_search_to_near_place: function () {\n            var radios = $(\"#new-select\").find(\"input[type='radio']\");\n            radios.attr(\"checked\", \"\");\n            $(\"#new-search-radio-place\").attr(\"checked\", \"checked\");\n            radios.checkboxradio(\"refresh\");\n        },\n\n        /**\n         * are we adding near me, or near a place?\n         * @param e {event}\n         */\n        add_search_radio_change: function (e) {\n            switch ($(this).val()) {\n                case \"place\":\n                    $(\"#new-place-near\").show();\n                    $(\"#new-search-place-btn\").show();\n                    break;\n                case \"me\":\n                    $(\"#new-place-near\").hide();\n                    $(\"#new-search-place-btn\").hide();\n                    BB.lookupMyAddress(e);\n                    break;\n            }\n\n        },\n\n        /**\n         * event listeners\n         */\n        setupListeners: function () {\n            $(\"#new-shout-form\").submit(BB.saveItemAtPos);\n            //when the cam icon is clicked, send a click to the file input widget\n            $(\"#new-item-camera-img\").on(\"click\", BB.take_photo_click);\n            $(\"#camera-dlg-btn\").on(\"click\", BB.take_photo_click);\n            $(\"#file-dlg-btn\").on(\"click\", BB.open_image_file_click);\n            //$(\"#item-camera-img\").on(\"click\",  take_photo_click);\n            //hide the default one\n            var img_input = $(\"#image-input\");\n            img_input.hide();\n            img_input.change(BB.imagePreview);\n            $(\"div\").find(\"[data-controltype='camerainput']\").hide();\n            //vote buttons\n            $(\"#refresh-btn\").on(\"click\", BB.fullLoadUserData);\n\n            $(\"#create-new-save-btn\").on(\"click\", BB.do_create_new_address);\n            $(\"#create-new-address-btn\").on(\n                \"click\", BB.show_create_new_address);\n            $(\"#new-item-li\").on(\"click\", BB.show_create_new_address);\n            $(\"#item-edit\").on(\"click\", BB.editItem);\n            $(\"#new-rotr\").on(\"click\", BB.imageRotate);\n            $(\"#new-address-next-btn\").on(\"click\", BB.lookupManualAddress);\n            $(\"#enter-new-addr-btn\").on(\"click\", BB.lookupManualAddress);\n            $(\"#new-address-my-locn-btn\").on(\"click\", BB.lookupMyAddress);\n            $(\"#forgot-btn\").attr(\"data-ajax\", \"false\");\n            $(\"#column-headers\").find(\"span\").on(\"click\", BB.clickColumnHeader);\n            BB.set_list_column_filter('mine');\n            $(\"#filter-radio\").on(\"change\", BB.clickColumnHeader);\n            $(\"#sort-dist\").addClass(\"list-sort-selected\");\n            $(\"#col-mine\").addClass(\"list-filter-selected\");\n            $(\"#new-place-name-box\").on('change input', BB.place_search_by_name);\n            $(\"#new-place-near\").on('keyup', BB.set_search_to_near_place);\n            $(\"#new-search-place-btn\").click(BB.lookupManualAddress);\n            $(\"#new-top-controls\").find(\"input[type='radio']\").bind(\"change\",\n                BB.add_search_radio_change);\n            // edit item btn hidden by default. Shown if you own it\n            // event handler for map search box on map-page\n            $(\"#map-search\").keyup(BB.map_search_key);\n            $(\"#item-see-map\").on(\"click\", BB.showItemOnMap);\n            $(\"#item-web-link\").on(\"click\", BB.showItemWebPage);\n            $(\"#new-item-save\").on(\"click\", BB.new_item_save_click);\n            $(\"#item-save\").on(\"click\", BB.updateitem);\n            $('#new-preview-box').hide();\n            //on click map search btn, simulate Enter key in search box\n            $(\"#map-search-btn\").on(\"click\", BB.mapSearchClick);\n            $(\"#map-search-btn-box\").on(\"click\", BB.mapSearchClick);\n            $(\"#map-search-btn-box\").hide();\n            var search_box = $(\"#main-search\");\n            search_box.on('keyup change', BB.list_text_filter);\n            $(\"#item-delete\").on(\"click\", BB.itemDelete);\n            $(\"#new-item-delete\").on(\"click\", BB.itemDelete);\n            search_box.parent().removeClass('ui-body-a').addClass('ui-body-b');\n            search_box.removeClass('ui-body-a').addClass('ui-body-b');\n            $(\"#test-loc-set\").change(BB.set_test_location);\n            $('#item-descr').keypress(BB.comment_validate);\n            $(\"#settings-save-profile\").click(BB.save_profile);\n            $(\"#new-search-title-btn\").click(BB.add_search_name);\n            $(\"#new-search-name-btn\").click(BB.lookupMyAddress);\n            $('#new-category').keyup(BB.cuisine_keyup);\n            $('#cuisine-lookup').click(BB.cuisine_lookup_click);\n\n\n            /*window.onerror = function errorHandler(msg, url, line) {\n             alert(msg + \": \" + line);\n             // Just let default handler run.\n             return false;\n             }*/\n        },\n\n\n        loadUserData: function () {\n            rayv.UserData.load(\n                function () {\n                    BB.populateMainList(\"\");\n                });\n        },\n\n        fullLoadUserData: function () {\n            rayv.UserData.lastUpdate.set(0);\n            BB.loadUserData();\n        }\n    }\n    ;\n\n\n$(function () {\n        function onPageShow(event, ui) {\n            var previousPage = ui.prevPage.attr(\"id\");\n            switch (event.target.id) {\n                case \"list-page\":\n                    BB.pageToList(event, previousPage);\n                    break;\n                case \"map-page\":\n                    BB.pageToMap(event);\n                    break;\n                case \"new-place\":\n                    BB.pageToNewPlace(event, previousPage);\n                    break;\n                case \"image-page\":\n                    BB.pageToImage(event);\n                    break;\n                case \"new-detail\":\n                    BB.hide_waiting();\n                    if (rayv.currentItem.key) {\n                        BB.page_to_edit_item();\n                    }\n                    break;\n                case \"item-page\":\n                    BB.pageToItem(event, previousPage);\n                    break;\n                case \"create-new-address\":\n                    BB.pageToCreateAddress(event, previousPage);\n                    break;\n                case \"new-address-list-page\":\n                    $(\"#new-addresses-list\").\n                        trigger('create').\n                        trigger('updatelayout');\n                    try {\n                        $(\"#new-addresses-list\").listview('refresh');\n                    } catch (e) {\n                    }\n                    break;\n                case \"settings-page\":\n                    $.get('/user_profile', {}, function (data) {\n                        $(\"#settings-screen-name\").\n                            val(jQuery.parseJSON(data).screen_name);\n                    });\n                    break;\n            }\n        }\n\n        function beforePageShow(event, data) {\n            //some pages are ones you mustn't land on from\n            // outside as they need loading\n            console.log(\"beforePageShow \" +\n                data.prevPage.attr(\"id\") + \">\" +\n                event.target.id);\n            if (event.target.id == \"item-page\") {\n                BB.clearItemPage();\n            }\n            if ((event.target.id == \"item-page\") ||\n                (event.target.id == \"map-page\") ||\n                (event.target.id == \"new-detail\") ||\n//            (event.target.id == \"new-page\") ||\n                (event.target.id == \"new-address-list-page\") ||\n                (event.target.id == \"create-new-address\") ||\n                (event.target.id == \"new-place\")) {\n                if (!data.prevPage.attr(\"id\"))\n                    $.mobile.changePage(\"#list-page\");\n            }\n\n            if (event.target.id == \"map-page\") {\n                if (!BB.theMap) {\n                    BB.map_init();\n                }\n            }\n//\n            if (event.target.id == \"new-place\") {\n                if (data.prevPage.attr(\"id\") == \"new-detail\") {\n                    //coming back from new page\n                }\n            }\n            if (!BB.navBarActive) {\n                event.preventDefault();\n            }\n            //$(\"#item-img\").hide();\n        }\n\n\n        try {\n            $('div[data-role=page]').bind('pageshow', onPageShow);\n            $(document).bind(\"pagebeforeshow\", beforePageShow);\n        }\n        catch (e) {\n            BB.log(e);\n        }\n\n        // change the default jquery \"contains\" selector so\n        // it matches case insensitive\n        // from: http://css-tricks.com/snippets/jquery/\n        // make-jquery-contains-case-insensitive/\n        $.expr[\":\"].contains = $.expr.createPseudo(function (arg) {\n            return function (elem) {\n                return $(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;\n            };\n        });\n\n\n        if (!navigator.geolocation) {\n            console.error(\"$. NEED GEO\");\n            alert(\"LBS Are Off\");\n            //todo: Note: jQuery.mobile.changePage is deprecated as of\n            // jQuery Mobile 1.4.0 and will be removed in 1.5.0. Use the\n            // pagecontainer widget's change() method instead.\n            //   $( \":mobile-pagecontainer\" ).pagecontainer(\n            // \"change\", \"need-geo.html\");\n            $.mobile.changePage(\"/need-geo.html\")\n        }\n        else {\n            console.log(\"populateMainList call\");\n\n\n            window.scrollTo(0, 1);\n        }\n\n\n        BB.lastGPSTime = 0;\n        if (!navigator.geolocation) {\n            alert(\"Please check Location Services are on for Safari\");\n            console.log(\"Could not get position\");\n            $.mobile.changePage(\"#need-geo\");\n        }\n        else {\n            navigator.geolocation.getCurrentPosition(\n                BB.firstWatchPositionSuccess,\n                BB.watchPositionError,\n                BB.watchPositionOptions)\n        }\n        BB.cuisine_load_categories();\n        BB.setupListeners();\n        console.log(\"JS Init'd\");\n        $(\"#loading\").html('.');\n\n    }\n)\n;\n\n","undoManager":{"mark":0,"position":14,"stack":[[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":1,"column":15},"end":{"row":1,"column":16}},"text":" "},{"action":"insertText","range":{"start":{"row":1,"column":18},"end":{"row":1,"column":19}},"text":" "},{"action":"insertText","range":{"start":{"row":8,"column":22},"end":{"row":8,"column":23}},"text":" "},{"action":"insertText","range":{"start":{"row":8,"column":33},"end":{"row":8,"column":34}},"text":" "},{"action":"insertText","range":{"start":{"row":11,"column":32},"end":{"row":11,"column":33}},"text":" "},{"action":"insertText","range":{"start":{"row":11,"column":35},"end":{"row":11,"column":36}},"text":" "},{"action":"insertText","range":{"start":{"row":14,"column":40},"end":{"row":14,"column":41}},"text":" "},{"action":"insertText","range":{"start":{"row":14,"column":48},"end":{"row":14,"column":49}},"text":" "},{"action":"insertText","range":{"start":{"row":21,"column":35},"end":{"row":21,"column":36}},"text":" "},{"action":"insertText","range":{"start":{"row":21,"column":38},"end":{"row":21,"column":39}},"text":" "},{"action":"insertText","range":{"start":{"row":22,"column":9},"end":{"row":22,"column":10}},"text":" "},{"action":"insertText","range":{"start":{"row":22,"column":12},"end":{"row":22,"column":13}},"text":" "},{"action":"insertText","range":{"start":{"row":24,"column":40},"end":{"row":24,"column":41}},"text":" "},{"action":"removeText","range":{"start":{"row":36,"column":4},"end":{"row":36,"column":8}},"text":"var "},{"action":"insertText","range":{"start":{"row":36,"column":4},"end":{"row":36,"column":9}},"text":"this."},{"action":"insertText","range":{"start":{"row":46,"column":15},"end":{"row":46,"column":16}},"text":" "},{"action":"removeText","range":{"start":{"row":47,"column":47},"end":{"row":47,"column":48}},"text":"["},{"action":"insertText","range":{"start":{"row":47,"column":47},"end":{"row":47,"column":52}},"text":".get("},{"action":"removeText","range":{"start":{"row":47,"column":55},"end":{"row":47,"column":56}},"text":"]"},{"action":"insertText","range":{"start":{"row":47,"column":55},"end":{"row":47,"column":56}},"text":")"},{"action":"insertText","range":{"start":{"row":49,"column":17},"end":{"row":49,"column":18}},"text":" "},{"action":"insertText","range":{"start":{"row":72,"column":0},"end":{"row":72,"column":39}},"text":"        rayv.currentItem.lat = obj.lat;"},{"action":"insertText","range":{"start":{"row":72,"column":39},"end":{"row":73,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":73,"column":0},"end":{"row":74,"column":0}},"lines":["        rayv.currentItem.lng = obj.lng;"]},{"action":"insertText","range":{"start":{"row":80,"column":8},"end":{"row":80,"column":25}},"text":"rayv.currentItem."},{"action":"insertText","range":{"start":{"row":91,"column":54},"end":{"row":91,"column":55}},"text":" "},{"action":"removeText","range":{"start":{"row":107,"column":0},"end":{"row":107,"column":20}},"text":"    this.friends = {"},{"action":"removeLines","range":{"start":{"row":101,"column":0},"end":{"row":107,"column":0}},"nl":"\n","lines":["//todo: put this in local storage","rayv.UserData = rayv.UserData||{};","(function(){","    var my_id =0;","    this.places ={};","    this.myBook = {};"]},{"action":"insertText","range":{"start":{"row":101,"column":0},"end":{"row":101,"column":26}},"text":"ImageStore = function () {"},{"action":"insertText","range":{"start":{"row":101,"column":26},"end":{"row":102,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":102,"column":0},"end":{"row":283,"column":0}},"lines":["    var images = [];","    this.is_empty = function(){","        return images.length == 0;","    };","    this.load_image = function (key, src) {","        var image;","        if (images[key]) {","            image = images[key];","        }","        else {","            image = new Image()","        }","        image.src = src;","        image.className = 'item-pic';","        images[key] = image;","    };","    this.refresh_image = function(key, src){","        if (images[key]){","            return;","        }","        this.load_image(key, src);","    };","    this.get_image = function (key) {","        return images[key];","    };","    this.assign_image = function (img_el, key){","        if (images[key]){","            $(img_el).replaceWith(images[key])","        }","        else{","            console.error('ImageStore.assign_image: '+key)","        }","    }","};","","DictStore = function (dict_name) {","    this.dict_name = dict_name;","    var has_local_storage = !(typeof window.localStorage == 'undefined');","    var mem_data = null;","    this.make_key = function (k) {","        return this.dict_name + ':' + k;","    };","","    this.is_empty = function () {","        // try a load first","        if (mem_data && mem_data.length > 0) {","            return false;","        }","        this.load();","        // if, after a load, still empty then it's Really Empty","        if (!mem_data || mem_data.length == 0) {","            return true;","        }","        ;","        return false;","    };","    /**","     * load from localStorage","     */","    this.load = function () {","        mem_data = {};","        var item_key_starts_at = this.dict_name.length + 1;","        for (var i = 0; i < window.localStorage.length; i++) {","            var key = window.localStorage.key(i);","            if (key.indexOf(this.dict_name) == 0) {","","                var stored = window.localStorage.getItem(key);","                if (stored) {","                    var k = key.substring(item_key_starts_at);","                    var obj = JSON.parse(stored);","                    mem_data[k] = obj;","                }","                ;","            }","        }","    };","    /**","     * Store in mem & localStorage","     * @param k {string} key","     * @param v {Object} value - must be serialisable","     */","    this.set = function (k, v) {","        if (!mem_data) {","            this.load();","        }","        mem_data[k] = v;","        if (has_local_storage) {","            var json_val = JSON.stringify(v);","            window.localStorage.setItem(this.make_key(k), json_val);","        }","    };","    /**","     * get value from local storage","     * @param k {string} key","     * @returns {Object}","     */","    this.get = function (k) {","        if (!mem_data) {","            this.load();","        }","        if (mem_data.hasOwnProperty(k)) {","            return mem_data[k];","        }","        return null;","    };","    this.exists = function (k) {","        if (!mem_data) {","            this.load();","        }","        if (mem_data.hasOwnProperty(k)) {","            return true;","        }","        return false;","    };","    this.clear = function () {","        if (has_local_storage) {","            for (k in mem_data) {","                window.localStorage.removeItem(this.make_key(k));","            }","        }","        mem_data = {};","    };","    this.forEach = function (fn) {","        for (k in mem_data) {","            fn(mem_data[k]);","        }","    }","","};","","ObjectStore = function (obj_name) {","    this.obj_name = obj_name;","    var has_local_storage = !(typeof window.localStorage == 'undefined');","    var obj = null;","    /**","     * load from localStorage","     */","    this.load = function () {","        obj = JSON.parse(localStorage.getItem(this.obj_name + ':'));","    };","    /**","     * Store in mem & localStorage","     * @param k {string} key","     * @param v {Object} value - must be serialisable","     */","    this.set = function (v) {","        if (!obj) {","            this.load();","        }","        obj = v;","        if (has_local_storage) {","            var json_val = JSON.stringify(v);","            window.localStorage.setItem(this.obj_name + ':', json_val);","        }","    };","    this.get = function () {","        if (!obj) {","            this.load();","        }","        return obj;","    };","","};","","//todo: put this in local storage","rayv.UserData = rayv.UserData || {};","(function () {","    this.places = new DictStore('PLACE');","    this.myBook = new ObjectStore('MYBOOK');","    this.friends = new DictStore('FRIEND');","    this.lastUpdate = new ObjectStore('LASTUPDATE');","","    this.init = function () {","        var LSsupport = !(typeof window.localStorage == 'undefined');","        if (LSsupport) {","            console.log(\"localStorage and sessionStorage are available\");","            this.has_local_storage = true;","            this.storage = window.localStorage;","        }","        rayv.UserData.my_id = new ObjectStore('my_id');","        rayv.UserData.my_id.set(0);"]},{"action":"insertText","range":{"start":{"row":283,"column":0},"end":{"row":283,"column":4}},"text":"    "},{"action":"insertText","range":{"start":{"row":284,"column":0},"end":{"row":285,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":290,"column":26},"end":{"row":290,"column":27}},"text":" "},{"action":"removeText","range":{"start":{"row":291,"column":0},"end":{"row":291,"column":4}},"text":"    "},{"action":"removeText","range":{"start":{"row":290,"column":42},"end":{"row":291,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":291,"column":35},"end":{"row":291,"column":36}},"text":" "},{"action":"removeText","range":{"start":{"row":294,"column":17},"end":{"row":294,"column":31}},"text":"(place.key in "},{"action":"insertText","range":{"start":{"row":294,"column":37},"end":{"row":294,"column":54}},"text":".exists(place.key"},{"action":"removeText","range":{"start":{"row":296,"column":36},"end":{"row":296,"column":37}},"text":"["},{"action":"insertText","range":{"start":{"row":296,"column":36},"end":{"row":296,"column":41}},"text":".set("},{"action":"removeText","range":{"start":{"row":296,"column":50},"end":{"row":296,"column":59}},"text":"] = place"},{"action":"insertText","range":{"start":{"row":296,"column":50},"end":{"row":296,"column":59}},"text":", place);"},{"action":"insertText","range":{"start":{"row":296,"column":59},"end":{"row":297,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":297,"column":0},"end":{"row":297,"column":68}},"text":"                BB.images.refresh_image(place.key, place.thumbnail);"},{"action":"insertText","range":{"start":{"row":305,"column":15},"end":{"row":305,"column":16}},"text":" "},{"action":"insertText","range":{"start":{"row":307,"column":0},"end":{"row":307,"column":57}},"text":"        var last_update = rayv.UserData.lastUpdate.get();"},{"action":"insertText","range":{"start":{"row":307,"column":57},"end":{"row":308,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":308,"column":0},"end":{"row":317,"column":0}},"lines":["        if (rayv.UserData.places.is_empty()){","            rayv.UserData.places.load();","        }","        BB.preload_images();","        if (last_update && !rayv.UserData.places.is_empty()) {","            request.since = last_update;","            callback();","        }","        else {"]},{"action":"insertText","range":{"start":{"row":317,"column":0},"end":{"row":317,"column":4}},"text":"    "},{"action":"insertText","range":{"start":{"row":318,"column":12},"end":{"row":318,"column":13}},"text":" "},{"action":"insertText","range":{"start":{"row":318,"column":13},"end":{"row":318,"column":16}},"text":"   "},{"action":"insertText","range":{"start":{"row":319,"column":0},"end":{"row":319,"column":13}},"text":"            }"},{"action":"insertText","range":{"start":{"row":319,"column":13},"end":{"row":320,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":328,"column":36},"end":{"row":328,"column":39}},"text":" = "},{"action":"insertText","range":{"start":{"row":328,"column":36},"end":{"row":328,"column":41}},"text":".set("},{"action":"insertText","range":{"start":{"row":328,"column":59},"end":{"row":328,"column":60}},"text":")"},{"action":"removeText","range":{"start":{"row":329,"column":16},"end":{"row":329,"column":23}},"text":"delete "},{"action":"removeText","range":{"start":{"row":329,"column":30},"end":{"row":329,"column":31}},"text":"p"},{"action":"removeText","range":{"start":{"row":330,"column":0},"end":{"row":330,"column":41}},"text":"                rayv.UserData.places = {}"},{"action":"removeText","range":{"start":{"row":329,"column":32},"end":{"row":329,"column":36}},"text":"ces;"},{"action":"removeText","range":{"start":{"row":329,"column":32},"end":{"row":330,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":329,"column":32},"end":{"row":329,"column":69}},"text":"stUpdate.set((new Date()).getTime());"},{"action":"insertText","range":{"start":{"row":329,"column":69},"end":{"row":330,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":330,"column":0},"end":{"row":333,"column":0}},"lines":["                if (!request.since) {","                    rayv.UserData.places.clear();","                }"]},{"action":"insertText","range":{"start":{"row":333,"column":0},"end":{"row":333,"column":16}},"text":"                "},{"action":"removeText","range":{"start":{"row":335,"column":16},"end":{"row":335,"column":23}},"text":"delete "},{"action":"removeText","range":{"start":{"row":336,"column":0},"end":{"row":336,"column":42}},"text":"                rayv.UserData.friends = {}"},{"action":"removeText","range":{"start":{"row":335,"column":37},"end":{"row":335,"column":38}},"text":";"},{"action":"removeText","range":{"start":{"row":335,"column":37},"end":{"row":336,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":335,"column":37},"end":{"row":335,"column":45}},"text":".clear()"},{"action":"removeText","range":{"start":{"row":340,"column":45},"end":{"row":340,"column":46}},"text":"["},{"action":"insertText","range":{"start":{"row":340,"column":45},"end":{"row":340,"column":50}},"text":".set("},{"action":"removeText","range":{"start":{"row":341,"column":0},"end":{"row":341,"column":27}},"text":"                           "},{"action":"removeText","range":{"start":{"row":340,"column":57},"end":{"row":340,"column":60}},"text":"] ="},{"action":"removeText","range":{"start":{"row":340,"column":57},"end":{"row":341,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":340,"column":57},"end":{"row":340,"column":58}},"text":","},{"action":"insertText","range":{"start":{"row":340,"column":63},"end":{"row":340,"column":64}},"text":")"},{"action":"insertText","range":{"start":{"row":353,"column":20},"end":{"row":353,"column":21}},"text":" "},{"action":"removeText","range":{"start":{"row":358,"column":44},"end":{"row":358,"column":45}},"text":"["},{"action":"insertText","range":{"start":{"row":358,"column":44},"end":{"row":358,"column":49}},"text":".get("},{"action":"removeText","range":{"start":{"row":358,"column":52},"end":{"row":358,"column":53}},"text":"]"},{"action":"insertText","range":{"start":{"row":358,"column":52},"end":{"row":358,"column":53}},"text":")"},{"action":"insertText","range":{"start":{"row":395,"column":36},"end":{"row":395,"column":37}},"text":" "},{"action":"insertText","range":{"start":{"row":395,"column":52},"end":{"row":395,"column":53}},"text":"{"},{"action":"removeText","range":{"start":{"row":396,"column":4},"end":{"row":396,"column":5}},"text":"{"},{"action":"insertText","range":{"start":{"row":396,"column":4},"end":{"row":396,"column":39}},"text":"    var myBook = this.myBook.get();"},{"action":"removeText","range":{"start":{"row":397,"column":12},"end":{"row":397,"column":17}},"text":"this."},{"action":"removeText","range":{"start":{"row":398,"column":19},"end":{"row":398,"column":24}},"text":"this."},{"action":"removeText","range":{"start":{"row":401,"column":8},"end":{"row":401,"column":37}},"text":"for (var idx in this.friends)"},{"action":"insertText","range":{"start":{"row":401,"column":8},"end":{"row":401,"column":25}},"text":"var comment = \"\";"},{"action":"insertText","range":{"start":{"row":401,"column":25},"end":{"row":402,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":402,"column":0},"end":{"row":402,"column":47}},"text":"        this.friends.forEach(function (friend) "},{"action":"removeLines","range":{"start":{"row":404,"column":0},"end":{"row":405,"column":0}},"nl":"\n","lines":["            var friend = this.friends[idx];"]},{"action":"removeText","range":{"start":{"row":405,"column":16},"end":{"row":405,"column":22}},"text":"return"},{"action":"insertText","range":{"start":{"row":405,"column":16},"end":{"row":405,"column":25}},"text":"comment ="},{"action":"insertText","range":{"start":{"row":407,"column":9},"end":{"row":407,"column":11}},"text":");"},{"action":"removeText","range":{"start":{"row":408,"column":15},"end":{"row":408,"column":17}},"text":"\"\""},{"action":"insertText","range":{"start":{"row":408,"column":15},"end":{"row":408,"column":22}},"text":"comment"},{"action":"removeText","range":{"start":{"row":418,"column":8},"end":{"row":418,"column":17}},"text":"if (this."},{"action":"insertText","range":{"start":{"row":418,"column":8},"end":{"row":418,"column":39}},"text":"var myBook = this.myBook.get();"},{"action":"insertText","range":{"start":{"row":418,"column":39},"end":{"row":419,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":419,"column":0},"end":{"row":419,"column":12}},"text":"        if ("},{"action":"removeText","range":{"start":{"row":420,"column":19},"end":{"row":420,"column":24}},"text":"this."},{"action":"insertText","range":{"start":{"row":430,"column":29},"end":{"row":430,"column":30}},"text":" "},{"action":"removeText","range":{"start":{"row":431,"column":0},"end":{"row":431,"column":4}},"text":"    "},{"action":"removeText","range":{"start":{"row":430,"column":45},"end":{"row":431,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":432,"column":8},"end":{"row":432,"column":29}},"text":"for (var idx in this."},{"action":"insertText","range":{"start":{"row":432,"column":8},"end":{"row":432,"column":39}},"text":"this.friends.forEach(function ("},{"action":"removeText","range":{"start":{"row":432,"column":45},"end":{"row":432,"column":46}},"text":"s"},{"action":"insertText","range":{"start":{"row":432,"column":46},"end":{"row":432,"column":47}},"text":" "},{"action":"removeLines","range":{"start":{"row":434,"column":0},"end":{"row":435,"column":0}},"nl":"\n","lines":["            var friend = this.friends[idx];"]},{"action":"insertText","range":{"start":{"row":439,"column":9},"end":{"row":439,"column":11}},"text":");"},{"action":"insertText","range":{"start":{"row":444,"column":0},"end":{"row":445,"column":0}},"text":"\n"},{"action":"removeLines","range":{"start":{"row":447,"column":0},"end":{"row":451,"column":0}},"nl":"\n","lines":["        list_item_template: null,","        item_votes_template: null,","        friend_comment_template: null,","        add_search_nearby_template: null,"]},{"action":"removeText","range":{"start":{"row":454,"column":24},"end":{"row":454,"column":25}},"text":" "},{"action":"insertText","range":{"start":{"row":454,"column":43},"end":{"row":454,"column":44}},"text":" "},{"action":"insertText","range":{"start":{"row":458,"column":56},"end":{"row":458,"column":57}},"text":" "},{"action":"insertText","range":{"start":{"row":467,"column":41},"end":{"row":467,"column":42}},"text":" "},{"action":"insertText","range":{"start":{"row":474,"column":0},"end":{"row":474,"column":33}},"text":"        images: new ImageStore(),"},{"action":"insertText","range":{"start":{"row":474,"column":33},"end":{"row":475,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":475,"column":0},"end":{"row":480,"column":0}},"lines":["        preload_images: function(){","            rayv.UserData.places.forEach(function(place){","                BB.images.load_image(place.key, place.thumbnail);","            })","        },"]},{"action":"insertText","range":{"start":{"row":483,"column":30},"end":{"row":483,"column":31}},"text":" "},{"action":"insertText","range":{"start":{"row":483,"column":33},"end":{"row":483,"column":34}},"text":" "},{"action":"insertText","range":{"start":{"row":493,"column":30},"end":{"row":493,"column":31}},"text":" "},{"action":"insertText","range":{"start":{"row":493,"column":41},"end":{"row":493,"column":42}},"text":" "},{"action":"removeText","range":{"start":{"row":569,"column":45},"end":{"row":569,"column":61}},"text":"[obj.dirty_list."},{"action":"insertText","range":{"start":{"row":569,"column":45},"end":{"row":569,"column":50}},"text":".set("},{"action":"insertText","range":{"start":{"row":570,"column":28},"end":{"row":570,"column":43}},"text":"obj.dirty_list."},{"action":"removeText","range":{"start":{"row":570,"column":60},"end":{"row":570,"column":63}},"text":"] ="},{"action":"insertText","range":{"start":{"row":570,"column":60},"end":{"row":570,"column":61}},"text":","},{"action":"insertText","range":{"start":{"row":570,"column":61},"end":{"row":571,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":571,"column":0},"end":{"row":571,"column":27}},"text":"                           "},{"action":"insertText","range":{"start":{"row":571,"column":57},"end":{"row":571,"column":58}},"text":")"},{"action":"removeText","range":{"start":{"row":576,"column":44},"end":{"row":576,"column":60}},"text":"[obj.dirty_list."},{"action":"insertText","range":{"start":{"row":576,"column":44},"end":{"row":576,"column":49}},"text":".set("},{"action":"insertText","range":{"start":{"row":577,"column":28},"end":{"row":577,"column":43}},"text":"obj.dirty_list."},{"action":"removeText","range":{"start":{"row":577,"column":60},"end":{"row":577,"column":63}},"text":"] ="},{"action":"insertText","range":{"start":{"row":577,"column":60},"end":{"row":577,"column":61}},"text":","},{"action":"insertText","range":{"start":{"row":577,"column":61},"end":{"row":578,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":578,"column":0},"end":{"row":578,"column":27}},"text":"                           "},{"action":"insertText","range":{"start":{"row":578,"column":56},"end":{"row":578,"column":57}},"text":")"},{"action":"removeText","range":{"start":{"row":643,"column":12},"end":{"row":643,"column":16}},"text":"if ("},{"action":"insertText","range":{"start":{"row":643,"column":12},"end":{"row":643,"column":23}},"text":"var item = "},{"action":"removeText","range":{"start":{"row":644,"column":0},"end":{"row":644,"column":37}},"text":"                rayv.UserData.places["},{"action":"removeText","range":{"start":{"row":643,"column":39},"end":{"row":643,"column":70}},"text":".key in rayv.UserData.places) {"},{"action":"removeText","range":{"start":{"row":643,"column":39},"end":{"row":644,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":643,"column":39},"end":{"row":643,"column":40}},"text":";"},{"action":"insertText","range":{"start":{"row":643,"column":40},"end":{"row":644,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":644,"column":0},"end":{"row":644,"column":27}},"text":"            item.address = "},{"action":"removeText","range":{"start":{"row":644,"column":44},"end":{"row":644,"column":49}},"text":"key]."},{"action":"removeText","range":{"start":{"row":644,"column":51},"end":{"row":644,"column":53}},"text":" ="},{"action":"insertText","range":{"start":{"row":644,"column":51},"end":{"row":644,"column":52}},"text":";"},{"action":"removeText","range":{"start":{"row":645,"column":12},"end":{"row":645,"column":19}},"text":"       "},{"action":"insertText","range":{"start":{"row":645,"column":12},"end":{"row":645,"column":27}},"text":"item.category ="},{"action":"removeText","range":{"start":{"row":645,"column":45},"end":{"row":645,"column":52}},"text":"address"},{"action":"insertText","range":{"start":{"row":645,"column":45},"end":{"row":645,"column":53}},"text":"category"},{"action":"removeText","range":{"start":{"row":646,"column":12},"end":{"row":646,"column":37}},"text":"    rayv.UserData.places["},{"action":"insertText","range":{"start":{"row":646,"column":12},"end":{"row":646,"column":29}},"text":"if ((item.img != "},{"action":"removeText","range":{"start":{"row":646,"column":46},"end":{"row":646,"column":61}},"text":"key].category ="},{"action":"insertText","range":{"start":{"row":646,"column":46},"end":{"row":646,"column":53}},"text":"img) ||"},{"action":"removeText","range":{"start":{"row":647,"column":16},"end":{"row":647,"column":19}},"text":"   "},{"action":"insertText","range":{"start":{"row":647,"column":16},"end":{"row":647,"column":29}},"text":"(item.vote !="},{"action":"removeText","range":{"start":{"row":647,"column":47},"end":{"row":647,"column":56}},"text":"category;"},{"action":"insertText","range":{"start":{"row":647,"column":47},"end":{"row":647,"column":55}},"text":"vote)) {"},{"action":"removeText","range":{"start":{"row":650,"column":0},"end":{"row":650,"column":39}},"text":"                    (rayv.UserData.plac"},{"action":"removeLines","range":{"start":{"row":649,"column":0},"end":{"row":650,"column":0}},"nl":"\n","lines":["                    rayv.currentItem.img) ||"]},{"action":"removeText","range":{"start":{"row":648,"column":16},"end":{"row":648,"column":70}},"text":"if ((rayv.UserData.places[rayv.currentItem.key].img !="},{"action":"removeText","range":{"start":{"row":648,"column":16},"end":{"row":649,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":648,"column":16},"end":{"row":648,"column":62}},"text":"console.log(\"Can't update in cache - reload\");"},{"action":"insertText","range":{"start":{"row":648,"column":62},"end":{"row":649,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":649,"column":0},"end":{"row":652,"column":0}},"lines":["                return false;","            }","            var myBook = rayv.UserData.myBook.get();"]},{"action":"insertText","range":{"start":{"row":652,"column":0},"end":{"row":652,"column":33}},"text":"            var vote = myBook.vot"},{"action":"removeText","range":{"start":{"row":652,"column":57},"end":{"row":652,"column":65}},"text":".vote !="},{"action":"insertText","range":{"start":{"row":652,"column":57},"end":{"row":652,"column":58}},"text":";"},{"action":"removeText","range":{"start":{"row":654,"column":0},"end":{"row":654,"column":66}},"text":"                    console.log(\"Can't update in cache - reload\");"},{"action":"removeText","range":{"start":{"row":653,"column":12},"end":{"row":653,"column":49}},"text":"            rayv.currentItem.vote)) {"},{"action":"removeText","range":{"start":{"row":653,"column":12},"end":{"row":654,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":653,"column":12},"end":{"row":653,"column":24}},"text":"if (!vote) {"},{"action":"insertText","range":{"start":{"row":653,"column":24},"end":{"row":654,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":654,"column":0},"end":{"row":656,"column":0}},"lines":["                myBook.votes[rayv.currentItem.key] = {","                    vote: 0,"]},{"action":"insertText","range":{"start":{"row":656,"column":0},"end":{"row":656,"column":32}},"text":"                    comment: '',"},{"action":"removeText","range":{"start":{"row":657,"column":20},"end":{"row":657,"column":26}},"text":"return"},{"action":"insertText","range":{"start":{"row":657,"column":20},"end":{"row":657,"column":28}},"text":"untried:"},{"action":"removeText","range":{"start":{"row":657,"column":34},"end":{"row":657,"column":35}},"text":";"},{"action":"insertText","range":{"start":{"row":658,"column":17},"end":{"row":658,"column":18}},"text":";"},{"action":"removeText","range":{"start":{"row":659,"column":16},"end":{"row":659,"column":30}},"text":"rayv.UserData."},{"action":"insertText","range":{"start":{"row":659,"column":16},"end":{"row":659,"column":23}},"text":"vote = "},{"action":"removeText","range":{"start":{"row":659,"column":57},"end":{"row":659,"column":64}},"text":".vote ="},{"action":"insertText","range":{"start":{"row":659,"column":57},"end":{"row":659,"column":58}},"text":";"},{"action":"insertText","range":{"start":{"row":659,"column":58},"end":{"row":660,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":660,"column":0},"end":{"row":660,"column":13}},"text":"            }"},{"action":"insertText","range":{"start":{"row":661,"column":12},"end":{"row":661,"column":13}},"text":";"},{"action":"insertText","range":{"start":{"row":661,"column":13},"end":{"row":662,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":662,"column":12},"end":{"row":662,"column":16}},"text":"if ("},{"action":"removeText","range":{"start":{"row":662,"column":50},"end":{"row":662,"column":60}},"text":" ? -1 : 1;"},{"action":"insertText","range":{"start":{"row":662,"column":50},"end":{"row":662,"column":53}},"text":") {"},{"action":"removeText","range":{"start":{"row":663,"column":16},"end":{"row":663,"column":74}},"text":"rayv.UserData.myBook.votes[rayv.currentItem.key].comment ="},{"action":"insertText","range":{"start":{"row":663,"column":16},"end":{"row":663,"column":31}},"text":"vote.vote = -1;"},{"action":"insertText","range":{"start":{"row":664,"column":11},"end":{"row":664,"column":13}},"text":" }"},{"action":"insertText","range":{"start":{"row":664,"column":13},"end":{"row":665,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":665,"column":9},"end":{"row":665,"column":16}},"text":"   if ("},{"action":"removeText","range":{"start":{"row":671,"column":0},"end":{"row":671,"column":28}},"text":"                return false"},{"action":"removeLines","range":{"start":{"row":666,"column":0},"end":{"row":671,"column":0}},"nl":"\n","lines":["                console.log(\"Updated in cache \");","                return true;","            }","            else {","                console.log(\"New item for cache - reload\");"]},{"action":"removeText","range":{"start":{"row":665,"column":33},"end":{"row":665,"column":39}},"text":"descr;"},{"action":"removeText","range":{"start":{"row":665,"column":33},"end":{"row":666,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":665,"column":33},"end":{"row":665,"column":50}},"text":"vote == 'like') {"},{"action":"insertText","range":{"start":{"row":665,"column":50},"end":{"row":666,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":666,"column":0},"end":{"row":672,"column":0}},"lines":["                vote.vote = 1;","            }","            vote.untried = vote.vote == 0;","            vote.comment = rayv.currentItem.descr;","            rayv.UserData.myBook.set(myBook);","            console.log(\"Updated in cache \");"]},{"action":"insertText","range":{"start":{"row":672,"column":0},"end":{"row":672,"column":78}},"text":"            //rayv.UserData.places.set(rayv.currentItem.key, rayv.currentItem)"},{"action":"removeText","range":{"start":{"row":673,"column":12},"end":{"row":673,"column":13}},"text":"}"},{"action":"insertText","range":{"start":{"row":673,"column":12},"end":{"row":673,"column":24}},"text":"return true;"},{"action":"insertText","range":{"start":{"row":682,"column":16},"end":{"row":682,"column":20}},"text":"    "},{"action":"insertText","range":{"start":{"row":683,"column":20},"end":{"row":683,"column":21}},"text":" "},{"action":"insertText","range":{"start":{"row":683,"column":21},"end":{"row":683,"column":24}},"text":"   "},{"action":"insertText","range":{"start":{"row":684,"column":0},"end":{"row":684,"column":4}},"text":"    "},{"action":"insertText","range":{"start":{"row":685,"column":24},"end":{"row":685,"column":28}},"text":"    "},{"action":"insertText","range":{"start":{"row":686,"column":24},"end":{"row":686,"column":27}},"text":"   "},{"action":"insertText","range":{"start":{"row":686,"column":27},"end":{"row":686,"column":28}},"text":" "},{"action":"insertText","range":{"start":{"row":687,"column":0},"end":{"row":687,"column":4}},"text":"    "},{"action":"removeText","range":{"start":{"row":688,"column":20},"end":{"row":688,"column":21}},"text":"}"},{"action":"removeText","range":{"start":{"row":688,"column":20},"end":{"row":689,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":688,"column":20},"end":{"row":688,"column":25}},"text":"    }"},{"action":"insertText","range":{"start":{"row":688,"column":25},"end":{"row":689,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":689,"column":0},"end":{"row":689,"column":4}},"text":"    "},{"action":"insertText","range":{"start":{"row":690,"column":20},"end":{"row":690,"column":22}},"text":"  "},{"action":"insertText","range":{"start":{"row":690,"column":22},"end":{"row":690,"column":24}},"text":"  "},{"action":"insertText","range":{"start":{"row":691,"column":0},"end":{"row":691,"column":4}},"text":"    "},{"action":"removeText","range":{"start":{"row":692,"column":16},"end":{"row":692,"column":17}},"text":"}"},{"action":"removeText","range":{"start":{"row":692,"column":16},"end":{"row":693,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":692,"column":16},"end":{"row":692,"column":21}},"text":"    }"},{"action":"insertText","range":{"start":{"row":692,"column":21},"end":{"row":693,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":693,"column":0},"end":{"row":693,"column":4}},"text":"    "},{"action":"insertText","range":{"start":{"row":754,"column":67},"end":{"row":754,"column":70}},"text":"res"},{"action":"insertText","range":{"start":{"row":759,"column":0},"end":{"row":759,"column":59}},"text":"                                rayv.currentItem.key = res;"},{"action":"insertText","range":{"start":{"row":759,"column":59},"end":{"row":760,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":790,"column":39},"end":{"row":790,"column":42}},"text":") {"},{"action":"insertText","range":{"start":{"row":790,"column":39},"end":{"row":790,"column":45}},"text":"res) {"},{"action":"insertText","range":{"start":{"row":790,"column":45},"end":{"row":791,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":791,"column":0},"end":{"row":794,"column":0}},"lines":["                        var it = JSON.parse(res);","                        BB.set_distance_for_place(it);","                        rayv.UserData.places.set(it.key, it);"]},{"action":"insertText","range":{"start":{"row":794,"column":0},"end":{"row":794,"column":61}},"text":"                        rayv.currentItem.loadFromKey(it.key);"},{"action":"insertText","range":{"start":{"row":803,"column":35},"end":{"row":803,"column":36}},"text":" "},{"action":"insertText","range":{"start":{"row":804,"column":24},"end":{"row":804,"column":27}},"text":"BB."},{"action":"removeLines","range":{"start":{"row":883,"column":0},"end":{"row":888,"column":0}},"nl":"\n","lines":["            var LIPrototype =","                \"<li data-theme='c' \" +","                \"data-icon='false'>\" +","                    \"<a style='background-color:white;' onclick='\";",""]},{"action":"removeText","range":{"start":{"row":889,"column":12},"end":{"row":889,"column":26}},"text":"for (var it in"},{"action":"insertText","range":{"start":{"row":889,"column":12},"end":{"row":889,"column":23}},"text":"var votes ="},{"action":"insertText","range":{"start":{"row":889,"column":45},"end":{"row":889,"column":57}},"text":"get().votes;"},{"action":"insertText","range":{"start":{"row":889,"column":57},"end":{"row":890,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":890,"column":0},"end":{"row":890,"column":27}},"text":"            for (var it in "},{"action":"removeText","range":{"start":{"row":893,"column":20},"end":{"row":893,"column":41}},"text":"rayv.UserData.myBook."},{"action":"removeText","range":{"start":{"row":896,"column":37},"end":{"row":896,"column":38}},"text":" "},{"action":"removeText","range":{"start":{"row":898,"column":0},"end":{"row":898,"column":16}},"text":"                "},{"action":"removeLines","range":{"start":{"row":897,"column":0},"end":{"row":898,"column":0}},"nl":"\n","lines":["                {"]},{"action":"removeText","range":{"start":{"row":898,"column":16},"end":{"row":898,"column":31}},"text":"               "},{"action":"removeText","range":{"start":{"row":898,"column":16},"end":{"row":898,"column":34}},"text":" for (var fIdx in "},{"action":"removeText","range":{"start":{"row":901,"column":0},"end":{"row":901,"column":16}},"text":"                "},{"action":"removeLines","range":{"start":{"row":899,"column":0},"end":{"row":901,"column":0}},"nl":"\n","lines":["                                    //noinspection JSUnfilteredForInLoop","                                    var friend = rayv.UserData.friends[fIdx];"]},{"action":"removeText","range":{"start":{"row":898,"column":37},"end":{"row":898,"column":40}},"text":") {"},{"action":"removeText","range":{"start":{"row":898,"column":37},"end":{"row":899,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":898,"column":37},"end":{"row":898,"column":65}},"text":".forEach(function (friend) {"},{"action":"insertText","range":{"start":{"row":898,"column":65},"end":{"row":899,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":900,"column":24},"end":{"row":900,"column":40}},"text":"                "},{"action":"removeText","range":{"start":{"row":901,"column":24},"end":{"row":901,"column":31}},"text":"       "},{"action":"removeText","range":{"start":{"row":901,"column":24},"end":{"row":901,"column":33}},"text":"         "},{"action":"removeText","range":{"start":{"row":902,"column":28},"end":{"row":902,"column":43}},"text":"               "},{"action":"removeText","range":{"start":{"row":902,"column":28},"end":{"row":902,"column":29}},"text":" "},{"action":"removeText","range":{"start":{"row":906,"column":0},"end":{"row":906,"column":17}},"text":"                }"},{"action":"removeLines","range":{"start":{"row":904,"column":0},"end":{"row":906,"column":0}},"nl":"\n","lines":["                                    }","                                }"]},{"action":"removeText","range":{"start":{"row":903,"column":24},"end":{"row":903,"column":41}},"text":"                }"},{"action":"removeText","range":{"start":{"row":903,"column":24},"end":{"row":904,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":903,"column":24},"end":{"row":903,"column":25}},"text":"}"},{"action":"insertText","range":{"start":{"row":903,"column":25},"end":{"row":904,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":904,"column":0},"end":{"row":905,"column":0}},"lines":["                    }"]},{"action":"insertText","range":{"start":{"row":905,"column":0},"end":{"row":905,"column":19}},"text":"                });"},{"action":"removeText","range":{"start":{"row":909,"column":48},"end":{"row":909,"column":49}},"text":"["},{"action":"insertText","range":{"start":{"row":909,"column":48},"end":{"row":909,"column":53}},"text":".get("},{"action":"removeText","range":{"start":{"row":909,"column":58},"end":{"row":909,"column":59}},"text":"]"},{"action":"insertText","range":{"start":{"row":909,"column":58},"end":{"row":909,"column":59}},"text":")"},{"action":"removeText","range":{"start":{"row":964,"column":0},"end":{"row":964,"column":77}},"text":"                            \"' href='#new-detail' data-transition='slide'>\" +"},{"action":"removeLines","range":{"start":{"row":959,"column":0},"end":{"row":964,"column":0}},"nl":"\n","lines":["                            BB.format(","                                \"javascript:loadMapItemForEdit(\" +","                                    \"'{0}','{1}','{2}');\",","                                geoPt.place_name, geoPt.lat, geoPt.lng);","                        newListItemEnd = click_fn +"]},{"action":"removeText","range":{"start":{"row":958,"column":24},"end":{"row":958,"column":34}},"text":"click_fn ="},{"action":"removeText","range":{"start":{"row":958,"column":24},"end":{"row":959,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":958,"column":24},"end":{"row":958,"column":55}},"text":"newListItem = templates.render("},{"action":"insertText","range":{"start":{"row":958,"column":55},"end":{"row":959,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":959,"column":0},"end":{"row":959,"column":53}},"text":"                            'list-geo-item-template',"},{"action":"insertText","range":{"start":{"row":960,"column":28},"end":{"row":960,"column":30}},"text":"{'"},{"action":"removeText","range":{"start":{"row":962,"column":0},"end":{"row":962,"column":66}},"text":"                        newListItem = LIPrototype + newListItemEnd"},{"action":"removeLines","range":{"start":{"row":961,"column":0},"end":{"row":962,"column":0}},"nl":"\n","lines":["                            \" [\" + geoPt.distance + \"]</a></li>\";"]},{"action":"removeText","range":{"start":{"row":960,"column":35},"end":{"row":960,"column":48}},"text":".place_name +"},{"action":"removeText","range":{"start":{"row":960,"column":35},"end":{"row":961,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":960,"column":35},"end":{"row":960,"column":44}},"text":"': geoPt}"},{"action":"insertText","range":{"start":{"row":960,"column":44},"end":{"row":961,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":961,"column":0},"end":{"row":961,"column":25}},"text":"                        )"},{"action":"removeText","range":{"start":{"row":971,"column":38},"end":{"row":971,"column":49}},"text":"Mark.up(BB."},{"action":"insertText","range":{"start":{"row":971,"column":38},"end":{"row":971,"column":55}},"text":"templates.render("},{"action":"insertText","range":{"start":{"row":971,"column":55},"end":{"row":972,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":972,"column":0},"end":{"row":972,"column":29}},"text":"                            '"},{"action":"removeText","range":{"start":{"row":972,"column":33},"end":{"row":972,"column":34}},"text":"_"},{"action":"insertText","range":{"start":{"row":972,"column":33},"end":{"row":972,"column":34}},"text":"-"},{"action":"removeText","range":{"start":{"row":972,"column":38},"end":{"row":972,"column":39}},"text":"_"},{"action":"insertText","range":{"start":{"row":972,"column":38},"end":{"row":972,"column":39}},"text":"-"},{"action":"removeText","range":{"start":{"row":972,"column":47},"end":{"row":972,"column":48}},"text":","},{"action":"insertText","range":{"start":{"row":972,"column":47},"end":{"row":972,"column":49}},"text":"',"},{"action":"insertText","range":{"start":{"row":972,"column":49},"end":{"row":973,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":973,"column":0},"end":{"row":973,"column":27}},"text":"                           "},{"action":"insertText","range":{"start":{"row":1005,"column":0},"end":{"row":1005,"column":52}},"text":"                $(UIlist).find('a').each(function(){"},{"action":"insertText","range":{"start":{"row":1005,"column":52},"end":{"row":1006,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1006,"column":0},"end":{"row":1011,"column":0}},"lines":["                    BB.images.assign_image(","                        $(this).find('#div_left').find('img'),","                        $(this).data('key')","                    );","                })"]},{"action":"removeText","range":{"start":{"row":1043,"column":0},"end":{"row":1043,"column":13}},"text":"            }"},{"action":"removeLines","range":{"start":{"row":1029,"column":0},"end":{"row":1043,"column":0}},"nl":"\n","lines":["                //load from file","                $.get(","                    'static/templates/list-item-template.htt',","                    null,","                    function (data) {","                        BB.list_item_template = data;","","                        return inner_setup_list();","                    }","                )","            }","","            else {","                return inner_setup_list();"]},{"action":"removeText","range":{"start":{"row":1028,"column":12},"end":{"row":1028,"column":48}},"text":"if (BB.list_item_template == null) {"},{"action":"removeText","range":{"start":{"row":1028,"column":12},"end":{"row":1029,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1028,"column":12},"end":{"row":1028,"column":38}},"text":"return inner_setup_list();"},{"action":"removeText","range":{"start":{"row":1068,"column":0},"end":{"row":1068,"column":8}},"text":"        "},{"action":"removeText","range":{"start":{"row":1067,"column":38},"end":{"row":1068,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1090,"column":47},"end":{"row":1090,"column":48}},"text":" "},{"action":"removeText","range":{"start":{"row":1095,"column":12},"end":{"row":1095,"column":28}},"text":"for (var key in "},{"action":"removeText","range":{"start":{"row":1097,"column":0},"end":{"row":1097,"column":54}},"text":"                var place = rayv.UserData.places[key];"},{"action":"removeLines","range":{"start":{"row":1096,"column":0},"end":{"row":1097,"column":0}},"nl":"\n","lines":["                //noinspection JSUnfilteredForInLoop"]},{"action":"removeText","range":{"start":{"row":1095,"column":32},"end":{"row":1095,"column":34}},"text":"){"},{"action":"removeText","range":{"start":{"row":1095,"column":32},"end":{"row":1096,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1095,"column":32},"end":{"row":1095,"column":59}},"text":".forEach(function (place) {"},{"action":"insertText","range":{"start":{"row":1102,"column":13},"end":{"row":1102,"column":15}},"text":");"},{"action":"insertText","range":{"start":{"row":1126,"column":41},"end":{"row":1126,"column":42}},"text":" "},{"action":"insertText","range":{"start":{"row":1126,"column":44},"end":{"row":1126,"column":45}},"text":" "},{"action":"insertText","range":{"start":{"row":1127,"column":38},"end":{"row":1127,"column":39}},"text":" "},{"action":"insertText","range":{"start":{"row":1135,"column":24},"end":{"row":1135,"column":25}},"text":" "},{"action":"insertText","range":{"start":{"row":1135,"column":31},"end":{"row":1135,"column":32}},"text":" "},{"action":"removeText","range":{"start":{"row":1137,"column":32},"end":{"row":1137,"column":33}},"text":"="},{"action":"insertText","range":{"start":{"row":1137,"column":32},"end":{"row":1137,"column":35}},"text":" = "},{"action":"removeText","range":{"start":{"row":1137,"column":41},"end":{"row":1137,"column":42}},"text":"<"},{"action":"insertText","range":{"start":{"row":1137,"column":41},"end":{"row":1137,"column":44}},"text":" < "},{"action":"insertText","range":{"start":{"row":1137,"column":73},"end":{"row":1137,"column":74}},"text":" "},{"action":"insertText","range":{"start":{"row":1144,"column":49},"end":{"row":1144,"column":50}},"text":" "},{"action":"insertText","range":{"start":{"row":1144,"column":52},"end":{"row":1144,"column":53}},"text":" "},{"action":"insertText","range":{"start":{"row":1146,"column":61},"end":{"row":1146,"column":62}},"text":" "},{"action":"removeText","range":{"start":{"row":1149,"column":26},"end":{"row":1149,"column":27}},"text":" "},{"action":"removeText","range":{"start":{"row":1149,"column":46},"end":{"row":1149,"column":47}},"text":" "},{"action":"removeText","range":{"start":{"row":1150,"column":16},"end":{"row":1150,"column":20}},"text":"    "},{"action":"removeText","range":{"start":{"row":1150,"column":16},"end":{"row":1150,"column":20}},"text":"    "},{"action":"removeText","range":{"start":{"row":1152,"column":24},"end":{"row":1152,"column":25}},"text":"="},{"action":"insertText","range":{"start":{"row":1152,"column":24},"end":{"row":1152,"column":27}},"text":" = "},{"action":"removeText","range":{"start":{"row":1152,"column":33},"end":{"row":1152,"column":34}},"text":"<"},{"action":"insertText","range":{"start":{"row":1152,"column":33},"end":{"row":1152,"column":36}},"text":" < "},{"action":"insertText","range":{"start":{"row":1152,"column":72},"end":{"row":1152,"column":73}},"text":" "},{"action":"removeText","range":{"start":{"row":1153,"column":24},"end":{"row":1153,"column":25}},"text":" "},{"action":"removeText","range":{"start":{"row":1155,"column":26},"end":{"row":1155,"column":27}},"text":" "},{"action":"removeText","range":{"start":{"row":1155,"column":33},"end":{"row":1155,"column":34}},"text":" "},{"action":"removeText","range":{"start":{"row":1155,"column":65},"end":{"row":1155,"column":66}},"text":" "},{"action":"removeText","range":{"start":{"row":1156,"column":35},"end":{"row":1156,"column":36}},"text":" "},{"action":"removeText","range":{"start":{"row":1156,"column":46},"end":{"row":1156,"column":47}},"text":" "},{"action":"removeText","range":{"start":{"row":1159,"column":31},"end":{"row":1159,"column":32}},"text":" "},{"action":"removeText","range":{"start":{"row":1159,"column":40},"end":{"row":1159,"column":41}},"text":" "},{"action":"insertText","range":{"start":{"row":1160,"column":42},"end":{"row":1160,"column":43}},"text":" "},{"action":"insertText","range":{"start":{"row":1163,"column":16},"end":{"row":1163,"column":17}},"text":" "},{"action":"insertText","range":{"start":{"row":1168,"column":42},"end":{"row":1168,"column":43}},"text":" "},{"action":"insertText","range":{"start":{"row":1168,"column":45},"end":{"row":1168,"column":46}},"text":" "},{"action":"insertText","range":{"start":{"row":1171,"column":42},"end":{"row":1171,"column":43}},"text":" "},{"action":"insertText","range":{"start":{"row":1171,"column":45},"end":{"row":1171,"column":46}},"text":" "},{"action":"insertText","range":{"start":{"row":1176,"column":31},"end":{"row":1176,"column":32}},"text":" "},{"action":"insertText","range":{"start":{"row":1176,"column":34},"end":{"row":1176,"column":35}},"text":" "},{"action":"insertText","range":{"start":{"row":1180,"column":42},"end":{"row":1180,"column":43}},"text":" "},{"action":"insertText","range":{"start":{"row":1180,"column":45},"end":{"row":1180,"column":46}},"text":" "},{"action":"removeText","range":{"start":{"row":1181,"column":62},"end":{"row":1181,"column":63}},"text":">"},{"action":"insertText","range":{"start":{"row":1181,"column":62},"end":{"row":1181,"column":65}},"text":" > "},{"action":"insertText","range":{"start":{"row":1181,"column":68},"end":{"row":1181,"column":69}},"text":" "},{"action":"insertText","range":{"start":{"row":1184,"column":20},"end":{"row":1184,"column":21}},"text":" "},{"action":"insertText","range":{"start":{"row":1190,"column":38},"end":{"row":1190,"column":39}},"text":" "},{"action":"insertText","range":{"start":{"row":1190,"column":41},"end":{"row":1190,"column":42}},"text":" "},{"action":"removeText","range":{"start":{"row":1197,"column":51},"end":{"row":1197,"column":52}},"text":"+"},{"action":"insertText","range":{"start":{"row":1197,"column":51},"end":{"row":1197,"column":54}},"text":" + "},{"action":"insertText","range":{"start":{"row":1199,"column":42},"end":{"row":1199,"column":43}},"text":" "},{"action":"removeText","range":{"start":{"row":1266,"column":0},"end":{"row":1266,"column":24}},"text":"            el.html(data"},{"action":"removeLines","range":{"start":{"row":1259,"column":0},"end":{"row":1266,"column":0}},"nl":"\n","lines":["         * ajax callback on loaded list of possible places to Add","         * @param data {object} server data","         */","        loadPlacesListSuccessHandler: function (data) {","            console.log(\"loadPlacesListSuccessHandler\");","            BB.navBarEnable();","            var el = $(\"#new-place-list\");"]},{"action":"removeText","range":{"start":{"row":1258,"column":8},"end":{"row":1258,"column":11}},"text":"/**"},{"action":"removeText","range":{"start":{"row":1258,"column":8},"end":{"row":1259,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1258,"column":8},"end":{"row":1258,"column":47}},"text":"set_distance_for_place: function (pt) {"},{"action":"insertText","range":{"start":{"row":1258,"column":47},"end":{"row":1259,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1259,"column":0},"end":{"row":1283,"column":0}},"lines":["            var posn = new rayv.LatLng(pt.lat, pt.lng);","            pt.dist_float = BB.approx_distance(","                posn,","                BB.lastGPSPosition);","            var dist_str = BB.pretty_dist(pt.dist_float);","            pt.distance = dist_str;","        }, /**","         * ajax callback on loaded list of possible places to Add","         * @param data {object} server data","         */","        loadPlacesListSuccessHandler: function (data) {","            console.log(\"loadPlacesListSuccessHandler\");","            var obj = $.parseJSON(data);","            var pts = obj.local.points;","            for (var idx = 0; idx < pts.length; idx++) {","                var pt = pts[idx];","                BB.set_distance_for_place(pt);","            }","            pts.sort(function (a, b) {","                return a.dist_float - b.dist_float","            });","            var el = $(\"#new-place-list\");","            el.html(templates.render(","                'new-place-list-js',"]},{"action":"insertText","range":{"start":{"row":1283,"column":0},"end":{"row":1283,"column":45}},"text":"                {'points': obj.local.points})"},{"action":"insertText","range":{"start":{"row":1286,"column":0},"end":{"row":1286,"column":30}},"text":"            BB.navBarEnable();"},{"action":"insertText","range":{"start":{"row":1286,"column":30},"end":{"row":1287,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1330,"column":33},"end":{"row":1330,"column":34}},"text":" "},{"action":"insertText","range":{"start":{"row":1360,"column":43},"end":{"row":1360,"column":44}},"text":" "},{"action":"removeLines","range":{"start":{"row":1380,"column":0},"end":{"row":1382,"column":0}},"nl":"\n","lines":["",""]},{"action":"removeLines","range":{"start":{"row":1384,"column":0},"end":{"row":1409,"column":0}},"nl":"\n","lines":["            /**","             * load the list of votes for an item","             */","            //todo: use a template","            if (BB.item_votes_template == null) {","                //load from file","                $.get(","                    'static/templates/item-votes-list.htt',","                    null,","                    function (data) {","                        BB.item_votes_template = data;","                        BB.loadVotesInner();","                    }","                )","            }","            else {","                BB.loadVotesInner()","            }","        },","","        /**","         * success callback on get item detail page voted from server","         */","        loadVotesInner: function () ","        {"]},{"action":"removeText","range":{"start":{"row":1385,"column":12},"end":{"row":1385,"column":28}},"text":"for (var idx in "},{"action":"removeText","range":{"start":{"row":1389,"column":0},"end":{"row":1389,"column":16}},"text":"                "},{"action":"removeLines","range":{"start":{"row":1386,"column":0},"end":{"row":1389,"column":0}},"nl":"\n","lines":["                {","                                //noinspection JSUnfilteredForInLoop","                                var friend = rayv.UserData.friends[idx];"]},{"action":"removeText","range":{"start":{"row":1385,"column":33},"end":{"row":1385,"column":36}},"text":"){ "},{"action":"removeText","range":{"start":{"row":1385,"column":33},"end":{"row":1386,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1385,"column":33},"end":{"row":1385,"column":61}},"text":".forEach(function (friend) {"},{"action":"insertText","range":{"start":{"row":1385,"column":61},"end":{"row":1386,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1386,"column":45},"end":{"row":1386,"column":46}},"text":" "},{"action":"removeText","range":{"start":{"row":1387,"column":20},"end":{"row":1387,"column":36}},"text":"                "},{"action":"removeText","range":{"start":{"row":1388,"column":20},"end":{"row":1388,"column":21}},"text":" "},{"action":"removeText","range":{"start":{"row":1388,"column":20},"end":{"row":1388,"column":35}},"text":"               "},{"action":"removeText","range":{"start":{"row":1389,"column":20},"end":{"row":1389,"column":21}},"text":" "},{"action":"removeText","range":{"start":{"row":1389,"column":20},"end":{"row":1389,"column":35}},"text":"               "},{"action":"removeText","range":{"start":{"row":1390,"column":24},"end":{"row":1390,"column":25}},"text":" "},{"action":"removeText","range":{"start":{"row":1390,"column":24},"end":{"row":1390,"column":39}},"text":"               "},{"action":"removeText","range":{"start":{"row":1391,"column":24},"end":{"row":1391,"column":25}},"text":" "},{"action":"removeText","range":{"start":{"row":1391,"column":24},"end":{"row":1391,"column":39}},"text":"               "},{"action":"removeText","range":{"start":{"row":1393,"column":0},"end":{"row":1393,"column":12}},"text":"            "},{"action":"removeLines","range":{"start":{"row":1392,"column":0},"end":{"row":1393,"column":0}},"nl":"\n","lines":["                                    }"]},{"action":"insertText","range":{"start":{"row":1394,"column":13},"end":{"row":1394,"column":15}},"text":");"},{"action":"removeText","range":{"start":{"row":1397,"column":30},"end":{"row":1397,"column":41}},"text":"Mark.up(BB."},{"action":"insertText","range":{"start":{"row":1397,"column":30},"end":{"row":1397,"column":48}},"text":"templates.render('"},{"action":"removeText","range":{"start":{"row":1397,"column":52},"end":{"row":1397,"column":53}},"text":"_"},{"action":"insertText","range":{"start":{"row":1397,"column":52},"end":{"row":1397,"column":53}},"text":"-"},{"action":"removeText","range":{"start":{"row":1397,"column":58},"end":{"row":1397,"column":67}},"text":"_template"},{"action":"insertText","range":{"start":{"row":1397,"column":58},"end":{"row":1397,"column":64}},"text":"-list'"},{"action":"removeText","range":{"start":{"row":1409,"column":36},"end":{"row":1409,"column":37}},"text":"1"},{"action":"insertText","range":{"start":{"row":1409,"column":36},"end":{"row":1409,"column":40}},"text":"null"},{"action":"insertText","range":{"start":{"row":1414,"column":0},"end":{"row":1414,"column":65}},"text":"            else if ($('#item-like').hasClass('ui-btn-active')) {"},{"action":"insertText","range":{"start":{"row":1414,"column":65},"end":{"row":1415,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1415,"column":0},"end":{"row":1417,"column":0}},"lines":["                rayv.currentItem.vote = 1;","            }"]},{"action":"insertText","range":{"start":{"row":1421,"column":0},"end":{"row":1421,"column":54}},"text":"            if (!$.isNumeric(rayv.currentItem.vote)) {"},{"action":"insertText","range":{"start":{"row":1421,"column":54},"end":{"row":1422,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1422,"column":0},"end":{"row":1425,"column":0}},"lines":["                alert('You need to vote');","                return;","            }"]},{"action":"insertText","range":{"start":{"row":1473,"column":0},"end":{"row":1473,"column":52}},"text":"            var myBook = rayv.UserData.myBook.get();"},{"action":"insertText","range":{"start":{"row":1473,"column":52},"end":{"row":1474,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":1474,"column":40},"end":{"row":1474,"column":54}},"text":"rayv.UserData."},{"action":"removeLines","range":{"start":{"row":1482,"column":0},"end":{"row":1483,"column":0}},"nl":"\n","lines":["            //CATEGORY logic"]},{"action":"removeLines","range":{"start":{"row":1483,"column":0},"end":{"row":1484,"column":0}},"nl":"\n","lines":[""]},{"action":"removeLines","range":{"start":{"row":1484,"column":0},"end":{"row":1486,"column":0}},"nl":"\n","lines":["            $(\"#new-detail-comment\").val(","                rayv.UserData.get_most_relevant_comment(rayv.currentItem.key));"]},{"action":"removeText","range":{"start":{"row":1483,"column":14},"end":{"row":1483,"column":32}},"text":"END CATEGORY LOGIC"},{"action":"removeText","range":{"start":{"row":1483,"column":14},"end":{"row":1484,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1483,"column":14},"end":{"row":1483,"column":45}},"text":" add my comment if there is one"},{"action":"insertText","range":{"start":{"row":1483,"column":45},"end":{"row":1484,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1484,"column":0},"end":{"row":1488,"column":0}},"lines":["            if (myBook.votes[rayv.currentItem.key]) {","                $(\"#new-detail-comment\").val(","                    myBook.votes[rayv.currentItem.key].comment);","            }"]},{"action":"insertText","range":{"start":{"row":1488,"column":0},"end":{"row":1488,"column":13}},"text":"            ;"},{"action":"insertText","range":{"start":{"row":1527,"column":0},"end":{"row":1527,"column":37}},"text":"                $(\"#new-img\").show();"},{"action":"insertText","range":{"start":{"row":1527,"column":37},"end":{"row":1528,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1575,"column":36},"end":{"row":1575,"column":37}},"text":" "},{"action":"insertText","range":{"start":{"row":1597,"column":34},"end":{"row":1597,"column":35}},"text":" "},{"action":"removeLines","range":{"start":{"row":1648,"column":0},"end":{"row":1649,"column":0}},"nl":"\n","lines":[""]},{"action":"insertText","range":{"start":{"row":1673,"column":20},"end":{"row":1673,"column":24}},"text":"    "},{"action":"insertText","range":{"start":{"row":1674,"column":0},"end":{"row":1674,"column":4}},"text":"    "},{"action":"removeText","range":{"start":{"row":1679,"column":16},"end":{"row":1679,"column":24}},"text":"$(\"#item"},{"action":"insertText","range":{"start":{"row":1679,"column":16},"end":{"row":1679,"column":35}},"text":"// show the preview"},{"action":"insertText","range":{"start":{"row":1679,"column":35},"end":{"row":1680,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1680,"column":0},"end":{"row":1680,"column":23}},"text":"                $(\"#new"},{"action":"removeText","range":{"start":{"row":1803,"column":20},"end":{"row":1803,"column":21}},"text":" "},{"action":"removeText","range":{"start":{"row":1830,"column":12},"end":{"row":1830,"column":39}},"text":"function pageTo_item_inner("},{"action":"insertText","range":{"start":{"row":1830,"column":12},"end":{"row":1830,"column":36}},"text":"if (rayv.currentItem.key"},{"action":"insertText","range":{"start":{"row":1837,"column":16},"end":{"row":1837,"column":18}},"text":"//"},{"action":"removeLines","range":{"start":{"row":1841,"column":0},"end":{"row":1842,"column":0}},"nl":"\n","lines":[""]},{"action":"insertText","range":{"start":{"row":1876,"column":0},"end":{"row":1876,"column":36}},"text":"                // friends' comments"},{"action":"insertText","range":{"start":{"row":1876,"column":36},"end":{"row":1877,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":1884,"column":0},"end":{"row":1884,"column":31}},"text":"                            BB."},{"action":"removeText","range":{"start":{"row":1883,"column":32},"end":{"row":1883,"column":40}},"text":"Mark.up("},{"action":"removeText","range":{"start":{"row":1883,"column":32},"end":{"row":1884,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1883,"column":32},"end":{"row":1883,"column":50}},"text":"templates.render('"},{"action":"removeText","range":{"start":{"row":1883,"column":56},"end":{"row":1883,"column":57}},"text":"_"},{"action":"insertText","range":{"start":{"row":1883,"column":56},"end":{"row":1883,"column":57}},"text":"-"},{"action":"removeText","range":{"start":{"row":1883,"column":64},"end":{"row":1883,"column":65}},"text":"_"},{"action":"insertText","range":{"start":{"row":1883,"column":64},"end":{"row":1883,"column":65}},"text":"-"},{"action":"insertText","range":{"start":{"row":1883,"column":73},"end":{"row":1883,"column":74}},"text":"'"},{"action":"removeText","range":{"start":{"row":1884,"column":0},"end":{"row":1884,"column":27}},"text":"                           "},{"action":"removeText","range":{"start":{"row":1883,"column":75},"end":{"row":1884,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":1897,"column":20},"end":{"row":1897,"column":24}},"text":"if ("},{"action":"insertText","range":{"start":{"row":1897,"column":20},"end":{"row":1897,"column":31}},"text":"var vote = "},{"action":"insertText","range":{"start":{"row":1897,"column":52},"end":{"row":1897,"column":53}},"text":";"},{"action":"insertText","range":{"start":{"row":1897,"column":53},"end":{"row":1898,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1898,"column":0},"end":{"row":1899,"column":0}},"lines":["                    if ($.isNumeric(vote)) {"]},{"action":"insertText","range":{"start":{"row":1899,"column":0},"end":{"row":1899,"column":32}},"text":"                        if (vote"},{"action":"insertText","range":{"start":{"row":1900,"column":0},"end":{"row":1900,"column":4}},"text":"    "},{"action":"insertText","range":{"start":{"row":1901,"column":20},"end":{"row":1901,"column":24}},"text":"    "},{"action":"insertText","range":{"start":{"row":1902,"column":20},"end":{"row":1902,"column":21}},"text":" "},{"action":"insertText","range":{"start":{"row":1902,"column":21},"end":{"row":1902,"column":24}},"text":"   "},{"action":"insertText","range":{"start":{"row":1903,"column":0},"end":{"row":1903,"column":4}},"text":"    "},{"action":"insertText","range":{"start":{"row":1904,"column":0},"end":{"row":1904,"column":25}},"text":"                        }"},{"action":"insertText","range":{"start":{"row":1904,"column":25},"end":{"row":1905,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1920,"column":65},"end":{"row":1920,"column":71}},"text":"get()."},{"action":"removeText","range":{"start":{"row":1948,"column":0},"end":{"row":1948,"column":13}},"text":"            }"},{"action":"removeLines","range":{"start":{"row":1933,"column":0},"end":{"row":1948,"column":0}},"nl":"\n","lines":["","            if (rayv.currentItem.key) {","                if (BB.friend_comment_template == null) {","                    //load from file","                    $.get(","                        'static/templates/friend-comment-template.htt',","                        null,","                        function (template) {","                            BB.friend_comment_template = template;","                            pageTo_item_inner.call(this);","                        })","                }","                else {","                    pageTo_item_inner.call(this);","                }"]},{"action":"removeText","range":{"start":{"row":1932,"column":13},"end":{"row":1933,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":1985,"column":0},"end":{"row":1985,"column":70}},"text":"                    'static/templates/add-search-nearby-template.htt',"},{"action":"removeLines","range":{"start":{"row":1982,"column":0},"end":{"row":1985,"column":0}},"nl":"\n","lines":["            if (BB.add_search_nearby_template == null) {","                //load from file","                $.get("]},{"action":"removeText","range":{"start":{"row":1981,"column":8},"end":{"row":1981,"column":53}},"text":"process_template: function (data, callback) {"},{"action":"removeText","range":{"start":{"row":1981,"column":8},"end":{"row":1982,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1981,"column":8},"end":{"row":1981,"column":45}},"text":"lookupAddressList: function (event) {"},{"action":"insertText","range":{"start":{"row":1981,"column":45},"end":{"row":1982,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1982,"column":0},"end":{"row":1984,"column":0}},"lines":["            var addr;","            $(\"#new-place-list-loading\").show();"]},{"action":"insertText","range":{"start":{"row":1984,"column":0},"end":{"row":1984,"column":49}},"text":"            function lookAddressList_inner(obj) {"},{"action":"removeText","range":{"start":{"row":1985,"column":16},"end":{"row":1985,"column":25}},"text":"    null,"},{"action":"insertText","range":{"start":{"row":1985,"column":16},"end":{"row":1985,"column":21}},"text":"try {"},{"action":"insertText","range":{"start":{"row":1985,"column":21},"end":{"row":1986,"column":0}},"text":"\n"},{"action":"removeLines","range":{"start":{"row":1988,"column":0},"end":{"row":1990,"column":0}},"nl":"\n","lines":["                        BB.add_search_nearby_template = template;","                        callback(data);"]},{"action":"removeText","range":{"start":{"row":1987,"column":20},"end":{"row":1987,"column":41}},"text":"function (template) {"},{"action":"removeText","range":{"start":{"row":1987,"column":20},"end":{"row":1988,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1987,"column":20},"end":{"row":1987,"column":49}},"text":"BB.check_for_dirty_data(obj);"},{"action":"insertText","range":{"start":{"row":1987,"column":49},"end":{"row":1988,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1988,"column":0},"end":{"row":1991,"column":0}},"lines":["","                    //safe_title = .replace(/\\\"/g, \"&quot;\").replace(/\\'/g, \"&lsquo;\"),","                    // https://github.com/adammark/Markup.js/"]},{"action":"insertText","range":{"start":{"row":1991,"column":0},"end":{"row":1991,"column":3}},"text":"// "},{"action":"removeText","range":{"start":{"row":1991,"column":22},"end":{"row":1991,"column":25}},"text":" })"},{"action":"removeText","range":{"start":{"row":1991,"column":22},"end":{"row":1992,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1991,"column":22},"end":{"row":1991,"column":34}},"text":"Add Distance"},{"action":"insertText","range":{"start":{"row":1991,"column":34},"end":{"row":1992,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1992,"column":0},"end":{"row":1992,"column":2}},"text":"//"},{"action":"removeText","range":{"start":{"row":1992,"column":14},"end":{"row":1992,"column":15}},"text":"}"},{"action":"removeText","range":{"start":{"row":1992,"column":14},"end":{"row":1993,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":1994,"column":0},"end":{"row":1994,"column":1}},"text":" "},{"action":"removeLines","range":{"start":{"row":1993,"column":0},"end":{"row":1994,"column":0}},"nl":"\n","lines":["                callback(data);"]},{"action":"removeText","range":{"start":{"row":1992,"column":22},"end":{"row":1992,"column":32}},"text":"    else {"},{"action":"removeText","range":{"start":{"row":1992,"column":22},"end":{"row":1993,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1992,"column":22},"end":{"row":1992,"column":80}},"text":"for (var plIdx=0; plIdx<obj.local.points.length; plIdx++){"},{"action":"insertText","range":{"start":{"row":1992,"column":80},"end":{"row":1993,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1993,"column":0},"end":{"row":1993,"column":2}},"text":"//"},{"action":"removeText","range":{"start":{"row":1993,"column":13},"end":{"row":1993,"column":14}},"text":"}"},{"action":"removeText","range":{"start":{"row":1993,"column":13},"end":{"row":1994,"column":0}},"text":"\n"},{"action":"removeLines","range":{"start":{"row":1994,"column":0},"end":{"row":1995,"column":0}},"nl":"\n","lines":[""]},{"action":"removeText","range":{"start":{"row":1993,"column":21},"end":{"row":1993,"column":23}},"text":"},"},{"action":"removeText","range":{"start":{"row":1993,"column":21},"end":{"row":1994,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":1993,"column":26},"end":{"row":1993,"column":66}},"text":"   lookupAddressList: function (event) {"},{"action":"removeText","range":{"start":{"row":1993,"column":26},"end":{"row":1994,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1993,"column":26},"end":{"row":1993,"column":59}},"text":"var pt = obj.local.points[plIdx];"},{"action":"insertText","range":{"start":{"row":1993,"column":59},"end":{"row":1994,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1994,"column":0},"end":{"row":1994,"column":2}},"text":"//"},{"action":"removeText","range":{"start":{"row":1994,"column":14},"end":{"row":1994,"column":23}},"text":"var addr;"},{"action":"removeText","range":{"start":{"row":1994,"column":14},"end":{"row":1995,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1994,"column":14},"end":{"row":1994,"column":15}},"text":" "},{"action":"removeLines","range":{"start":{"row":1995,"column":0},"end":{"row":1996,"column":0}},"nl":"\n","lines":["            function lookAddressList_inner(obj) {"]},{"action":"removeText","range":{"start":{"row":1994,"column":26},"end":{"row":1994,"column":63}},"text":" $(\"#new-place-list-loading\").show();"},{"action":"removeText","range":{"start":{"row":1994,"column":26},"end":{"row":1995,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1994,"column":26},"end":{"row":1994,"column":59}},"text":"pt.distance = BB.approx_distance("},{"action":"insertText","range":{"start":{"row":1994,"column":59},"end":{"row":1995,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1995,"column":0},"end":{"row":1995,"column":2}},"text":"//"},{"action":"removeLines","range":{"start":{"row":1996,"column":0},"end":{"row":1997,"column":0}},"nl":"\n","lines":[""]},{"action":"removeText","range":{"start":{"row":1995,"column":16},"end":{"row":1995,"column":23}},"text":"  try {"},{"action":"removeText","range":{"start":{"row":1995,"column":16},"end":{"row":1996,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":1998,"column":0},"end":{"row":1998,"column":61}},"text":"                    // https://github.com/adammark/Markup.js/"},{"action":"removeLines","range":{"start":{"row":1996,"column":0},"end":{"row":1998,"column":0}},"nl":"\n","lines":["","                    //safe_title = .replace(/\\\"/g, \"&quot;\").replace(/\\'/g, \"&lsquo;\"),"]},{"action":"removeText","range":{"start":{"row":1995,"column":30},"end":{"row":1995,"column":65}},"text":"      BB.check_for_dirty_data(obj);"},{"action":"removeText","range":{"start":{"row":1995,"column":30},"end":{"row":1996,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":1995,"column":30},"end":{"row":1995,"column":52}},"text":"LatLng(pt.lat,pt.lng),"},{"action":"insertText","range":{"start":{"row":1995,"column":52},"end":{"row":1996,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1996,"column":0},"end":{"row":1997,"column":0}},"lines":["//                            BB.lastGPSPosition)"]},{"action":"insertText","range":{"start":{"row":1997,"column":0},"end":{"row":1997,"column":23}},"text":"//                    }"},{"action":"removeText","range":{"start":{"row":1999,"column":33},"end":{"row":1999,"column":44}},"text":"Mark.up(BB."},{"action":"insertText","range":{"start":{"row":1999,"column":33},"end":{"row":1999,"column":50}},"text":"templates.render("},{"action":"insertText","range":{"start":{"row":1999,"column":50},"end":{"row":2000,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":2000,"column":0},"end":{"row":2000,"column":25}},"text":"                        '"},{"action":"removeText","range":{"start":{"row":2000,"column":28},"end":{"row":2000,"column":29}},"text":"_"},{"action":"insertText","range":{"start":{"row":2000,"column":28},"end":{"row":2000,"column":29}},"text":"-"},{"action":"removeText","range":{"start":{"row":2000,"column":35},"end":{"row":2000,"column":36}},"text":"_"},{"action":"insertText","range":{"start":{"row":2000,"column":35},"end":{"row":2000,"column":36}},"text":"-"},{"action":"removeText","range":{"start":{"row":2000,"column":42},"end":{"row":2000,"column":43}},"text":"_"},{"action":"insertText","range":{"start":{"row":2000,"column":42},"end":{"row":2000,"column":43}},"text":"-"},{"action":"removeText","range":{"start":{"row":2000,"column":51},"end":{"row":2000,"column":52}},"text":","},{"action":"insertText","range":{"start":{"row":2000,"column":51},"end":{"row":2000,"column":53}},"text":"',"},{"action":"insertText","range":{"start":{"row":2000,"column":53},"end":{"row":2001,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":2001,"column":0},"end":{"row":2001,"column":23}},"text":"                       "},{"action":"removeText","range":{"start":{"row":2023,"column":0},"end":{"row":2023,"column":66}},"text":"                    jQuery.parseJSON(data), lookAddressList_inner)"},{"action":"removeText","range":{"start":{"row":2022,"column":16},"end":{"row":2022,"column":36}},"text":"BB.process_template("},{"action":"removeText","range":{"start":{"row":2022,"column":16},"end":{"row":2023,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":2022,"column":16},"end":{"row":2022,"column":62}},"text":"lookAddressList_inner(jQuery.parseJSON(data));"},{"action":"removeText","range":{"start":{"row":2033,"column":15},"end":{"row":2033,"column":48}},"text":" BB.process_template({items: []},"},{"action":"insertText","range":{"start":{"row":2033,"column":37},"end":{"row":2033,"column":49}},"text":"({items: []}"},{"action":"insertText","range":{"start":{"row":2108,"column":32},"end":{"row":2108,"column":33}},"text":" "},{"action":"insertText","range":{"start":{"row":2113,"column":38},"end":{"row":2113,"column":39}},"text":" "},{"action":"insertText","range":{"start":{"row":2117,"column":13},"end":{"row":2117,"column":14}},"text":" "},{"action":"removeText","range":{"start":{"row":2118,"column":0},"end":{"row":2118,"column":11}},"text":"           "},{"action":"removeText","range":{"start":{"row":2117,"column":18},"end":{"row":2118,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":2155,"column":61},"end":{"row":2155,"column":67}},"text":"get()."},{"action":"removeText","range":{"start":{"row":2253,"column":20},"end":{"row":2253,"column":24}},"text":"    "},{"action":"insertText","range":{"start":{"row":2278,"column":0},"end":{"row":2278,"column":35}},"text":"                    alert('Saved');"},{"action":"removeText","range":{"start":{"row":2327,"column":45},"end":{"row":2327,"column":46}},"text":"l"},{"action":"insertText","range":{"start":{"row":2327,"column":45},"end":{"row":2327,"column":50}},"text":"fullL"},{"action":"insertText","range":{"start":{"row":2383,"column":0},"end":{"row":2384,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":2389,"column":0},"end":{"row":2389,"column":10}},"text":"        },"},{"action":"insertText","range":{"start":{"row":2389,"column":10},"end":{"row":2390,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":2390,"column":0},"end":{"row":2394,"column":0}},"lines":["","        fullLoadUserData: function () {","            rayv.UserData.lastUpdate.set(0);","            BB.loadUserData();"]},{"action":"removeLines","range":{"start":{"row":2399,"column":0},"end":{"row":2400,"column":0}},"nl":"\n","lines":[""]},{"action":"insertText","range":{"start":{"row":2446,"column":58},"end":{"row":2447,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":2447,"column":0},"end":{"row":2447,"column":14}},"text":"            //"},{"action":"removeText","range":{"start":{"row":2480,"column":0},"end":{"row":2480,"column":11}},"text":"//        }"},{"action":"removeLines","range":{"start":{"row":2471,"column":0},"end":{"row":2480,"column":0}},"nl":"\n","lines":["//            var UIlist = Mark.up(BB.add_search_nearby_template, {});","//            $(\"#new-page\").append(UIlist).listview().trigger('create').trigger('updatelayout');","//        }","","//        if (event.target.id == \"new-page\") {","//            $(\"#search-location-loading\").hide();","//            //remove old results","//            $(\"#new-page ul\").remove();","//            BB.process_template({}, remove_old_place_searches);"]},{"action":"removeText","range":{"start":{"row":2470,"column":2},"end":{"row":2470,"column":48}},"text":"        function remove_old_place_searches() {"},{"action":"removeText","range":{"start":{"row":2470,"column":2},"end":{"row":2471,"column":0}},"text":"\n"},{"action":"removeText","range":{"start":{"row":2523,"column":0},"end":{"row":2523,"column":9}},"text":"        }"},{"action":"removeLines","range":{"start":{"row":2500,"column":0},"end":{"row":2523,"column":0}},"nl":"\n","lines":["","        //add a pipe to markup.js so we can do x-> 100%-x","        Mark.pipes.subFrom = function (a, b) {","            try {","                return parseInt(b,10) - parseInt(a,10);","            }","            catch (e) {","                return 0;","            }","        };","","","        //add a pipe to markup.js to show x if x>y","        Mark.pipes.above = function (a, b) {","            try {","                if (parseInt(a,10) > parseInt(b,10))","                    return a;","                else","                    return \"\";","            }","            catch (e) {","                return \"\";","            }"]},{"action":"removeText","range":{"start":{"row":2499,"column":10},"end":{"row":2499,"column":11}},"text":";"},{"action":"removeText","range":{"start":{"row":2499,"column":10},"end":{"row":2500,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":135,"column":0},"end":{"row":135,"column":2}},"text":"};"},{"action":"removeLines","range":{"start":{"row":101,"column":0},"end":{"row":135,"column":0}},"nl":"\n","lines":["ImageStore = function () {","    var images = [];","    this.is_empty = function(){","        return images.length == 0;","    };","    this.load_image = function (key, src) {","        var image;","        if (images[key]) {","            image = images[key];","        }","        else {","            image = new Image()","        }","        image.src = src;","        image.className = 'item-pic';","        images[key] = image;","    };","    this.refresh_image = function(key, src){","        if (images[key]){","            return;","        }","        this.load_image(key, src);","    };","    this.get_image = function (key) {","        return images[key];","    };","    this.assign_image = function (img_el, key){","        if (images[key]){","            $(img_el).replaceWith(images[key])","        }","        else{","            console.error('ImageStore.assign_image: '+key)","        }","    }"]}]}],[{"group":"doc","deltas":[{"action":"removeLines","range":{"start":{"row":100,"column":0},"end":{"row":101,"column":0}},"nl":"\n","lines":[""]}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":439,"column":8},"end":{"row":439,"column":33}},"text":"images: new ImageStore(),"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":439,"column":0},"end":{"row":439,"column":8}},"text":"        "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":438,"column":29},"end":{"row":439,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":974,"column":0},"end":{"row":974,"column":18}},"text":"                })"},{"action":"removeLines","range":{"start":{"row":970,"column":0},"end":{"row":974,"column":0}},"nl":"\n","lines":["                    BB.images.assign_image(","                        $(this).find('#div_left').find('img'),","                        $(this).data('key')","                    );"]},{"action":"removeText","range":{"start":{"row":969,"column":16},"end":{"row":969,"column":52}},"text":"$(UIlist).find('a').each(function(){"},{"action":"removeText","range":{"start":{"row":969,"column":16},"end":{"row":970,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":262,"column":16},"end":{"row":262,"column":68}},"text":"BB.images.refresh_image(place.key, place.thumbnail);"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":262,"column":0},"end":{"row":262,"column":16}},"text":"                "},{"action":"removeText","range":{"start":{"row":261,"column":59},"end":{"row":262,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":442,"column":0},"end":{"row":442,"column":10}},"text":"        },"},{"action":"removeLines","range":{"start":{"row":439,"column":0},"end":{"row":442,"column":0}},"nl":"\n","lines":["            rayv.UserData.places.forEach(function(place){","                BB.images.load_image(place.key, place.thumbnail);","            })"]},{"action":"removeText","range":{"start":{"row":438,"column":8},"end":{"row":438,"column":35}},"text":"preload_images: function(){"},{"action":"removeText","range":{"start":{"row":438,"column":8},"end":{"row":439,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":438,"column":4},"end":{"row":438,"column":8}},"text":"    "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":438,"column":0},"end":{"row":438,"column":4}},"text":"    "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":437,"column":29},"end":{"row":438,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":275,"column":0},"end":{"row":275,"column":28}},"text":"        BB.preload_images();"},{"action":"removeText","range":{"start":{"row":274,"column":9},"end":{"row":275,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":274,"column":9},"end":{"row":274,"column":10}},"text":";"}]}]]},"ace":{"folds":[],"scrolltop":2760.5,"scrollleft":0,"selection":{"start":{"row":274,"column":10},"end":{"row":274,"column":10},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":229,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1414621047000}